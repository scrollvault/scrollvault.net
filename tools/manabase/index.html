<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MTG Mana Base Calculator — How Many Lands? | Frank Karsten Math</title>
    <meta name="description" content="Free MTG mana base calculator powered by Frank Karsten's math. Find exactly how many lands and colored sources your deck needs. Works for Standard, Modern, Pioneer, Commander &amp; Limited. Import your decklist for instant results.">
    <meta name="robots" content="index, follow">
    <meta property="og:site_name" content="ScrollVault">
    <meta property="og:locale" content="en_US">
    <meta property="og:title" content="MTG Mana Base Calculator — How Many Lands Do You Need?">
    <meta property="og:description" content="Free mana base calculator for Magic: The Gathering. Uses Frank Karsten's proven hypergeometric math to compute exact land counts and colored sources for every format.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://scrollvault.net/tools/manabase/">
    <meta property="og:image" content="https://scrollvault.net/og-default.png">
    <meta property="og:image:alt" content="MTG Mana Base Calculator — How Many Lands Do You Need?">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="@scrollvault">
    <meta name="twitter:title" content="MTG Mana Base Calculator — Frank Karsten's Land Math">
    <meta name="twitter:description" content="Free mana base calculator for MTG. Karsten's hypergeometric math for exact land counts in Standard, Modern, Pioneer, and Commander.">
    <meta name="twitter:image" content="https://scrollvault.net/og-default.png">
    <meta name="twitter:image:alt" content="MTG Mana Base Calculator — How Many Lands Do You Need?">
    <link rel="canonical" href="https://scrollvault.net/tools/manabase/">
    <link rel="preload" href="/css/fonts/inter-latin.woff2" as="font" type="font/woff2" crossorigin>
    <link rel="preload" href="/css/fonts/space-grotesk-latin.woff2" as="font" type="font/woff2" crossorigin>
    <link rel="icon" href="/favicon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">
    <link rel="stylesheet" href="/tools/manabase/import.css">
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-1CV3DS33WK"></script>
    <script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js',new Date());gtag('config','G-1CV3DS33WK');</script>
<style>
@font-face {
  font-family: 'Inter';
  font-style: normal;
  font-weight: 400 700;
  font-display: swap;
  src: url('/css/fonts/inter-latin.woff2') format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+0304, U+0308, U+0329, U+2000-206F, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}
@font-face {
  font-family: 'Space Grotesk';
  font-style: normal;
  font-weight: 400 700;
  font-display: swap;
  src: url('/css/fonts/space-grotesk-latin.woff2') format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+0304, U+0308, U+0329, U+2000-206F, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}
/* ── Theme Variables ── */
:root {
    --bg-dark: #0f0f0f;
    --card-bg: #1a1a1a;
    --card-border: rgba(255,255,255,0.08);
    --card-hover-glow: rgba(139,92,246,0.25);
    --text-primary: #ffffff;
    --text-secondary: #a1a1aa;
    --text-muted: #71717a;
    --nav-bg: rgba(15,15,15,0.95);
    --nav-border: rgba(255,255,255,0.06);
    --gradient-purple: linear-gradient(135deg, #a855f7 0%, #6366f1 100%);
    --shadow-sm: 0 1px 2px rgba(0,0,0,0.3);
    --shadow-md: 0 4px 6px rgba(0,0,0,0.4);
    --shadow-lg: 0 10px 15px rgba(0,0,0,0.5);
    --color-W: #F9FAF4;
    --color-U: #0E68AB;
    --color-B: #150B00;
    --color-R: #D3202A;
    --color-G: #00733E;
}

* { margin: 0; padding: 0; box-sizing: border-box; }
html { scroll-behavior: smooth; }
body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg-dark); color: var(--text-primary); line-height: 1.6; min-height: 100vh; }
h1,h2,h3,h4,h5,h6 { font-family: 'Space Grotesk', -apple-system, sans-serif; font-weight: 600; line-height: 1.3; }
a { color: inherit; text-decoration: none; transition: color 0.2s ease; }
a:hover { color: #a78bfa; }
.container { max-width: 1280px; margin: 0 auto; padding: 0 1rem; }

/* ── Nav ── */
.nav { position: fixed; top: 0; left: 0; right: 0; background: var(--nav-bg); border-bottom: 1px solid var(--nav-border); z-index: 1000; height: 64px; display: flex; align-items: center; }
.nav-content { display: flex; justify-content: space-between; align-items: center; width: 100%; }
.nav-logo { font-family: 'Space Grotesk', sans-serif; font-size: 1.5rem; font-weight: 700; background: var(--gradient-purple); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
.nav-links { display: flex; gap: 2rem; list-style: none; }
.nav-links a { font-size: 0.9rem; font-weight: 500; color: var(--text-secondary); }
.nav-links a:hover, .nav-links a.active { color: var(--text-primary); }
.mobile-menu-btn { display: none; background: none; border: none; color: var(--text-primary); font-size: 1.5rem; cursor: pointer; }
@media (max-width: 768px) {
    .nav-links { display: none; position: absolute; top: 64px; left: 0; right: 0; background: var(--nav-bg); border-bottom: 1px solid var(--nav-border); flex-direction: column; padding: 1rem; gap: 0; }
    .nav-links.active { display: flex; }
    .nav-links a { padding: 0.75rem 1rem; display: block; border-bottom: 1px solid var(--card-border); }
    .nav-links a:last-child { border-bottom: none; }
    .mobile-menu-btn { display: block; }
}

/* ── Footer ── */
footer { border-top: 1px solid var(--card-border); padding: 2rem 0; margin-top: 4rem; }
.footer-content { display: flex; flex-direction: column; align-items: center; gap: 1rem; text-align: center; }
.footer-logo { font-family: 'Space Grotesk', sans-serif; font-size: 1.25rem; font-weight: 700; background: var(--gradient-purple); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
.footer-text { color: var(--text-muted); font-size: 0.875rem; }
.footer-links { display: flex; gap: 1.5rem; list-style: none; }
.footer-links a { color: var(--text-secondary); font-size: 0.875rem; }
.footer-links a:hover { color: var(--text-primary); }
.wubrg-dots { display: flex; gap: 0.5rem; justify-content: center; margin-top: 0.25rem; }
.mana-dot { width: 10px; height: 10px; border-radius: 50%; }

/* ── Main ── */
main { margin-top: 64px; min-height: calc(100vh - 64px); padding-bottom: 2rem; }

/* ── Breadcrumb ── */
.breadcrumb { padding: 1.25rem 0 0; font-size: 0.85rem; color: var(--text-muted); }
.breadcrumb a { color: var(--text-secondary); }
.breadcrumb a:hover { color: #a78bfa; }
.breadcrumb span { margin: 0 0.4rem; }

/* ── Hero ── */
.hero-section { padding: 2rem 0 2.5rem; text-align: center; }
.hero-section h1 { font-size: 2.5rem; margin-bottom: 0.5rem; background: var(--gradient-purple); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
.hero-section .subtitle { color: var(--text-secondary); font-size: 1.05rem; max-width: 640px; margin: 0 auto; }

/* ── Calculator Layout ── */
.calc-layout { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; }
@media (max-width: 960px) {
    .calc-layout { grid-template-columns: 1fr; }
}

/* ── Panels ── */
.panel { background: var(--card-bg); border: 1px solid var(--card-border); border-radius: 12px; padding: 1.5rem; }
.panel h2 { font-size: 1.15rem; margin-bottom: 1.25rem; display: flex; align-items: center; gap: 0.5rem; }
.panel h2 .icon { font-size: 1.1rem; }
.panel h3 { font-size: 0.95rem; margin-bottom: 0.75rem; color: var(--text-secondary); }

/* ── Format Selector ── */
.format-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 0.5rem; margin-bottom: 1.5rem; }
.format-btn { padding: 0.5rem 0.75rem; background: rgba(255,255,255,0.04); border: 1px solid var(--card-border); border-radius: 8px; font-size: 0.8rem; font-weight: 500; color: var(--text-secondary); cursor: pointer; font-family: inherit; transition: all 0.2s ease; text-align: center; }
.format-btn:hover { border-color: rgba(139,92,246,0.4); color: var(--text-primary); }
.format-btn.active { background: rgba(168,85,247,0.15); border-color: rgba(168,85,247,0.5); color: var(--text-primary); }
.format-btn .fmt-detail { display: block; font-size: 0.65rem; color: var(--text-muted); margin-top: 2px; }
.format-btn.active .fmt-detail { color: var(--text-secondary); }

/* ── Color Toggles ── */
.color-toggles { display: flex; gap: 0.75rem; margin-bottom: 1.5rem; justify-content: center; }
.color-toggle { width: 48px; height: 48px; border-radius: 50%; border: 3px solid transparent; cursor: pointer; font-weight: 700; font-size: 1rem; font-family: 'Space Grotesk', sans-serif; transition: all 0.2s ease; display: flex; align-items: center; justify-content: center; opacity: 0.4; position: relative; }
.color-toggle:hover { opacity: 0.7; transform: scale(1.08); }
.color-toggle.active { opacity: 1; border-color: rgba(168,85,247,0.7); transform: scale(1.1); box-shadow: 0 0 16px rgba(168,85,247,0.3); }
.color-toggle[data-color="W"] { background: var(--color-W); color: #333; }
.color-toggle[data-color="U"] { background: var(--color-U); color: #fff; }
.color-toggle[data-color="B"] { background: var(--color-B); color: #aaa; border: 3px solid rgba(255,255,255,0.15); }
.color-toggle[data-color="B"].active { border-color: rgba(168,85,247,0.7); }
.color-toggle[data-color="R"] { background: var(--color-R); color: #fff; }
.color-toggle[data-color="G"] { background: var(--color-G); color: #fff; }

/* ── Pip Inputs ── */
.pip-section { margin-bottom: 1.5rem; }
.pip-row { display: flex; align-items: center; gap: 0.75rem; padding: 0.6rem 0; border-bottom: 1px solid rgba(255,255,255,0.04); }
.pip-row:last-child { border-bottom: none; }
.pip-color-dot { width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: 700; flex-shrink: 0; }
.pip-label { flex: 1; font-size: 0.85rem; color: var(--text-secondary); }
.pip-controls { display: flex; align-items: center; gap: 0; }
.pip-btn { width: 32px; height: 32px; background: rgba(255,255,255,0.06); border: 1px solid var(--card-border); color: var(--text-primary); font-size: 1rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.15s ease; font-family: inherit; }
.pip-btn:hover { background: rgba(168,85,247,0.2); border-color: rgba(168,85,247,0.4); }
.pip-btn:first-child { border-radius: 6px 0 0 6px; }
.pip-btn:last-child { border-radius: 0 6px 6px 0; }
.pip-value { width: 40px; height: 32px; background: rgba(255,255,255,0.03); border: 1px solid var(--card-border); border-left: none; border-right: none; color: var(--text-primary); font-size: 0.9rem; font-weight: 600; text-align: center; font-family: inherit; }
.pip-value:focus { outline: none; background: rgba(168,85,247,0.1); }

/* ── Deck Size / Total Lands ── */
.size-inputs { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem; }
.size-group label { display: block; font-size: 0.8rem; color: var(--text-muted); margin-bottom: 0.35rem; }
.size-group input { width: 100%; padding: 0.5rem 0.75rem; background: rgba(255,255,255,0.04); border: 1px solid var(--card-border); border-radius: 8px; color: var(--text-primary); font-size: 1rem; font-weight: 600; font-family: inherit; text-align: center; }
.size-group input:focus { outline: none; border-color: rgba(168,85,247,0.5); background: rgba(168,85,247,0.08); }

/* ── Mana Curve ── */
.curve-section { margin-bottom: 1.5rem; }
.curve-inputs { display: grid; grid-template-columns: repeat(8, 1fr); gap: 0.4rem; }
.curve-col { text-align: center; }
.curve-col label { display: block; font-size: 0.7rem; color: var(--text-muted); margin-bottom: 0.3rem; font-weight: 500; }
.curve-col input { width: 100%; padding: 0.4rem; background: rgba(255,255,255,0.04); border: 1px solid var(--card-border); border-radius: 6px; color: var(--text-primary); font-size: 0.85rem; font-weight: 600; text-align: center; font-family: inherit; }
.curve-col input:focus { outline: none; border-color: rgba(168,85,247,0.5); background: rgba(168,85,247,0.08); }
.curve-total { margin-top: 0.5rem; font-size: 0.8rem; color: var(--text-muted); text-align: center; }
.curve-total strong { color: var(--text-primary); }

/* ── Calculate Button ── */
.calc-btn { display: block; width: 100%; padding: 0.85rem; background: var(--gradient-purple); border: none; border-radius: 10px; font-size: 1rem; font-weight: 600; color: white; cursor: pointer; font-family: 'Space Grotesk', sans-serif; transition: all 0.2s ease; margin-top: 0.5rem; }
.calc-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 24px rgba(139,92,246,0.4); }
.calc-btn:active { transform: translateY(0); }

/* ── Results Panel ── */
.results-empty { text-align: center; padding: 3rem 1rem; color: var(--text-muted); }
.results-empty .empty-icon { font-size: 3rem; margin-bottom: 1rem; opacity: 0.3; }
.results-empty p { font-size: 0.9rem; }

/* ── Land Count Cards ── */
.land-counts { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 0.75rem; margin-bottom: 1.75rem; }
.land-card { background: rgba(255,255,255,0.03); border: 1px solid var(--card-border); border-radius: 10px; padding: 1rem; text-align: center; transition: all 0.2s ease; position: relative; overflow: hidden; }
.land-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; }
.land-card[data-color="W"]::before { background: var(--color-W); }
.land-card[data-color="U"]::before { background: var(--color-U); }
.land-card[data-color="B"]::before { background: linear-gradient(90deg, #555, #333); }
.land-card[data-color="R"]::before { background: var(--color-R); }
.land-card[data-color="G"]::before { background: var(--color-G); }
.land-card[data-color="C"]::before { background: var(--gradient-purple); }
.land-card .land-count { font-family: 'Space Grotesk', sans-serif; font-size: 2rem; font-weight: 700; }
.land-card[data-color="W"] .land-count { color: var(--color-W); }
.land-card[data-color="U"] .land-count { color: var(--color-U); }
.land-card[data-color="B"] .land-count { color: #888; }
.land-card[data-color="R"] .land-count { color: var(--color-R); }
.land-card[data-color="G"] .land-count { color: var(--color-G); }
.land-card[data-color="C"] .land-count { color: #a78bfa; }
.land-card .land-label { font-size: 0.75rem; color: var(--text-muted); margin-top: 0.2rem; }
.land-card .land-pct { font-size: 0.7rem; color: var(--text-secondary); margin-top: 0.15rem; }

/* ── Bar Chart ── */
.chart-section { margin-bottom: 1.75rem; }
.bar-chart { display: flex; align-items: flex-end; gap: 8px; height: 140px; padding: 0 0.5rem; }
.bar-col { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 4px; min-width: 0; }
.bar-fill { width: 100%; border-radius: 4px 4px 0 0; transition: height 0.4s ease; min-height: 0; }
.bar-fill[data-color="W"] { background: var(--color-W); opacity: 0.85; }
.bar-fill[data-color="U"] { background: var(--color-U); }
.bar-fill[data-color="B"] { background: #555; }
.bar-fill[data-color="R"] { background: var(--color-R); }
.bar-fill[data-color="G"] { background: var(--color-G); }
.bar-fill[data-color="C"] { background: linear-gradient(180deg, #a855f7, #6366f1); }
.bar-label { font-size: 0.7rem; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; }
.bar-count { font-size: 0.7rem; color: var(--text-secondary); font-weight: 600; }

/* ── Probability Table ── */
.prob-section { margin-bottom: 1.75rem; }
.prob-table-wrapper { overflow-x: auto; }
.prob-table { width: 100%; border-collapse: collapse; font-size: 0.78rem; }
.prob-table th { padding: 0.5rem 0.6rem; text-align: center; font-weight: 600; color: var(--text-secondary); border-bottom: 2px solid var(--card-border); white-space: nowrap; background: rgba(255,255,255,0.02); }
.prob-table td { padding: 0.45rem 0.6rem; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.04); color: var(--text-secondary); font-variant-numeric: tabular-nums; }
.prob-table tr:hover td { background: rgba(168,85,247,0.05); }
.prob-table .turn-col { font-weight: 600; color: var(--text-primary); text-align: left; }
.prob-good { color: #4ade80; }
.prob-ok { color: #facc15; }
.prob-bad { color: #f87171; }

/* ── Suggested Mana Base ── */
.suggested-section { margin-bottom: 1.75rem; }
.suggest-card { background: rgba(255,255,255,0.03); border: 1px solid var(--card-border); border-radius: 8px; padding: 0.85rem 1rem; margin-bottom: 0.5rem; }
.suggest-card h4 { font-size: 0.85rem; margin-bottom: 0.35rem; color: var(--text-primary); }
.suggest-card p { font-size: 0.78rem; color: var(--text-secondary); line-height: 1.5; }
.suggest-card .suggest-lands { display: flex; flex-wrap: wrap; gap: 0.35rem; margin-top: 0.4rem; }
.suggest-land { display: inline-flex; align-items: center; gap: 0.3rem; background: rgba(168,85,247,0.1); border: 1px solid rgba(168,85,247,0.2); border-radius: 5px; padding: 0.2rem 0.5rem; font-size: 0.72rem; color: var(--text-secondary); }
.suggest-land .sl-count { font-weight: 700; color: var(--text-primary); }

/* ── Info Box ── */
.info-box { background: rgba(168,85,247,0.08); border: 1px solid rgba(168,85,247,0.2); border-radius: 10px; padding: 1.25rem; margin-top: 1.5rem; }
.info-box h3 { font-size: 0.95rem; margin-bottom: 0.5rem; color: #a78bfa; display: flex; align-items: center; gap: 0.4rem; }
.info-box p { font-size: 0.82rem; color: var(--text-secondary); line-height: 1.65; }
.info-box a { color: #a78bfa; text-decoration: underline; }
.info-box a:hover { color: #c4b5fd; }

/* ── FAQ Section ── */
.faq-section { margin-top: 2rem; }
.faq-section h2 { font-size: 1.4rem; margin-bottom: 1rem; color: var(--text-primary); }
.faq-section details { background: var(--card-bg); border: 1px solid var(--card-border); border-radius: 10px; margin-bottom: 0.75rem; overflow: hidden; }
.faq-section summary { padding: 1rem 1.25rem; font-weight: 600; font-size: 0.95rem; cursor: pointer; color: var(--text-primary); list-style: none; display: flex; justify-content: space-between; align-items: center; }
.faq-section summary::-webkit-details-marker { display: none; }
.faq-section summary::after { content: '+'; font-size: 1.2rem; color: var(--text-muted); flex-shrink: 0; margin-left: 1rem; }
.faq-section details[open] summary::after { content: '\2212'; }
.faq-section details[open] summary { border-bottom: 1px solid var(--card-border); }
.faq-section details p { padding: 1rem 1.25rem; font-size: 0.88rem; color: var(--text-secondary); line-height: 1.7; }

/* ── Responsive ── */
@media (max-width: 640px) {
    .hero-section h1 { font-size: 1.75rem; }
    .color-toggles { gap: 0.5rem; }
    .color-toggle { width: 40px; height: 40px; font-size: 0.85rem; }
    .curve-inputs { grid-template-columns: repeat(4, 1fr); }
    .land-counts { grid-template-columns: repeat(2, 1fr); }
    .format-grid { grid-template-columns: repeat(3, 1fr); }
    .size-inputs { grid-template-columns: 1fr; }
}
    </style>
</head>
<body>
    <nav class="nav">
        <div class="container nav-content">
            <a href="/" class="nav-logo">ScrollVault</a>
            <button class="mobile-menu-btn" onclick="document.getElementById('navLinks').classList.toggle('active')">&#9776;</button>
            <ul class="nav-links" id="navLinks">
                <li><a href="/">Home</a></li>
                <li><a href="/news/">News</a></li>
                <li><a href="/guides/">Guides</a></li>
                <li><a href="/decks/">Top Decks</a></li>
                <li><a href="/draft/">Draft</a></li>
                <li><a href="/tools/" class="active">Tools</a></li>
                <li><a href="/about.html">About</a></li>
                <li><a href="/contact.html">Contact</a></li>
            </ul>
        </div>
    </nav>

    <main>
        <div class="container">
            <div class="breadcrumb">
                <a href="/">Home</a><span>/</span>
                <a href="/tools/">Tools</a><span>/</span>
                Mana Base Calculator
            </div>

            <div class="hero-section">
                <h1>MTG Mana Base Calculator</h1>
                <p class="subtitle">How many lands should you run? Use Frank Karsten's mana math to calculate exact colored source counts for any MTG format. Import your decklist or enter your mana curve to build the perfect mana base.</p>
            </div>

            <div class="calc-layout">
                <!-- ═══ LEFT: Input Panel ═══ -->
                <div class="panel" id="inputPanel">
                    <h2><span class="icon">&#9881;</span> Deck Configuration</h2>

                    <!-- Tab Toggle -->
                    <div class="input-tabs">
                        <button class="input-tab active" data-tab="manual" onclick="switchTab('manual')">Manual</button>
                        <button class="input-tab" data-tab="import" onclick="switchTab('import')">Import Decklist</button>
                    </div>

                    <!-- Import Panel (hidden by default) -->
                    <div id="importPanel">
                        <p class="import-desc">Paste your decklist below. Supports MTGA, Moxfield, and standard "4 Card Name" format.</p>
                        <textarea class="import-textarea" id="decklistInput" placeholder="4 Lightning Bolt
4 Monastery Swiftspear
4 Goblin Guide
4 Eidolon of the Great Revel
4 Searing Blaze
20 Mountain
..."></textarea>
                        <div class="import-status" id="importStatus"></div>
                        <button class="calc-btn" style="margin-top:0.75rem;" onclick="importDecklist()">Parse &amp; Calculate</button>
                    </div>

                    <!-- Manual Panel -->
                    <div id="manualPanel" class="active">

                    <!-- Format Selector -->
                    <h3>Format</h3>
                    <div class="format-grid" id="formatGrid">
                        <button class="format-btn active" data-format="standard" data-deck="60" data-lands="24">
                            Standard
                            <span class="fmt-detail">60 / 24 lands</span>
                        </button>
                        <button class="format-btn" data-format="modern" data-deck="60" data-lands="23">
                            Modern
                            <span class="fmt-detail">60 / 23 lands</span>
                        </button>
                        <button class="format-btn" data-format="pioneer" data-deck="60" data-lands="24">
                            Pioneer
                            <span class="fmt-detail">60 / 24 lands</span>
                        </button>
                        <button class="format-btn" data-format="legacy" data-deck="60" data-lands="22">
                            Legacy
                            <span class="fmt-detail">60 / 22 lands</span>
                        </button>
                        <button class="format-btn" data-format="limited" data-deck="40" data-lands="17">
                            Limited
                            <span class="fmt-detail">40 / 17 lands</span>
                        </button>
                        <button class="format-btn" data-format="commander" data-deck="100" data-lands="37">
                            Commander
                            <span class="fmt-detail">100 / 37 lands</span>
                        </button>
                        <button class="format-btn" data-format="custom">
                            Custom
                            <span class="fmt-detail">Set your own</span>
                        </button>
                    </div>

                    <!-- Deck Size / Land Count -->
                    <div class="size-inputs">
                        <div class="size-group">
                            <label for="deckSize">Deck Size</label>
                            <input type="number" id="deckSize" value="60" min="20" max="250">
                        </div>
                        <div class="size-group">
                            <label for="totalLands">Total Lands</label>
                            <input type="number" id="totalLands" value="24" min="0" max="120">
                        </div>
                    </div>

                    <!-- Color Toggles -->
                    <h3>Colors</h3>
                    <div class="color-toggles" id="colorToggles">
                        <button class="color-toggle active" data-color="W" title="White">W</button>
                        <button class="color-toggle active" data-color="U" title="Blue">U</button>
                        <button class="color-toggle" data-color="B" title="Black">B</button>
                        <button class="color-toggle" data-color="R" title="Red">R</button>
                        <button class="color-toggle" data-color="G" title="Green">G</button>
                    </div>

                    <!-- Pip Inputs -->
                    <h3>Colored Mana Pips</h3>
                    <div class="pip-section" id="pipSection">
                        <!-- Populated by JS -->
                    </div>

                    <!-- Mana Curve -->
                    <div class="curve-section">
                        <h3>Mana Curve (Number of Spells)</h3>
                        <div class="curve-inputs" id="curveInputs">
                            <div class="curve-col">
                                <label>0 MV</label>
                                <input type="number" min="0" max="60" value="0" data-mv="0">
                            </div>
                            <div class="curve-col">
                                <label>1 MV</label>
                                <input type="number" min="0" max="60" value="8" data-mv="1">
                            </div>
                            <div class="curve-col">
                                <label>2 MV</label>
                                <input type="number" min="0" max="60" value="10" data-mv="2">
                            </div>
                            <div class="curve-col">
                                <label>3 MV</label>
                                <input type="number" min="0" max="60" value="8" data-mv="3">
                            </div>
                            <div class="curve-col">
                                <label>4 MV</label>
                                <input type="number" min="0" max="60" value="6" data-mv="4">
                            </div>
                            <div class="curve-col">
                                <label>5 MV</label>
                                <input type="number" min="0" max="60" value="3" data-mv="5">
                            </div>
                            <div class="curve-col">
                                <label>6 MV</label>
                                <input type="number" min="0" max="60" value="1" data-mv="6">
                            </div>
                            <div class="curve-col">
                                <label>7+</label>
                                <input type="number" min="0" max="60" value="0" data-mv="7">
                            </div>
                        </div>
                        <div class="curve-total" id="curveTotal">Spells: <strong>36</strong> / Lands: <strong>24</strong> / Total: <strong>60</strong></div>
                    </div>

                    <button class="calc-btn" id="calcBtn" onclick="calculate()">Calculate Mana Base</button>

                    </div><!-- /manualPanel -->
                </div>

                <!-- ═══ RIGHT: Results Panel ═══ -->
                <div class="panel" id="resultsPanel">
                    <h2><span class="icon">&#9733;</span> Results</h2>

                    <div id="resultsContent">
                        <div class="results-empty">
                            <div class="empty-icon">&#127183;</div>
                            <p>Select your colors and configure your deck, then click <strong>Calculate Mana Base</strong> to see results.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Info Box -->
            <div class="info-box">
                <h3>&#128218; How This Mana Calculator Works</h3>
                <p>
                    This MTG mana calculator implements <strong>Frank Karsten's mana math</strong>, the gold standard for manabase calculations.
                    Originally published in his ChannelFireball article
                    <a href="https://strategy.channelfireball.com/all-strategy/mtg/channelmagic-articles/how-many-colored-mana-sources-do-you-need-to-consistently-cast-your-spells-a-guilds-of-ravnica-update/" target="_blank" rel="noopener">"How Many Colored Mana Sources Do You Need to Consistently Cast Your Spells?"</a>,
                    Karsten's research uses <strong>hypergeometric probability</strong> to determine exactly how many mana sources of each color you need
                    to consistently cast your spells on curve.
                </p>
                <p style="margin-top: 0.5rem;">
                    For each colored mana symbol in your deck's casting costs, the calculator computes the optimal number of lands that produce that color.
                    It targets approximately a <strong>90% probability</strong> of having the right colors by the turn you need them.
                    Works for Standard, Modern, Pioneer, Legacy, and Commander mana bases &mdash; including 99-card singleton decks.
                    For a deeper look at manabase theory, read our <a href="/guides/mana-bases.html">complete mana base guide</a>.
                    Also see our <a href="/guides/dual-lands.html">dual land cycles reference</a> for every land cycle by format, and our <a href="/guides/commander-deck-building.html">Commander deck building guide</a> for EDH-specific mana base advice.
                </p>
            </div>

            <!-- FAQ Section (visible content for SEO + users) -->
            <section class="faq-section">
                <h2>Frequently Asked Questions</h2>

                <details open>
                    <summary>How many lands should I put in my MTG deck?</summary>
                    <p>For a 60-card deck (Standard, Modern, Pioneer), 23&ndash;26 lands is typical depending on your mana curve. Aggro decks run 22&ndash;23 lands, midrange runs 24&ndash;25, and control runs 25&ndash;26. For Commander (99 cards + commander), 35&ndash;38 lands is the standard range. Use a manabase calculator based on Frank Karsten&rsquo;s math for precise counts tailored to your specific deck.</p>
                </details>

                <details>
                    <summary>How many lands for a 60-card deck?</summary>
                    <p>Most competitive 60-card decks play between 22 and 26 lands. The exact number depends on your average mana value (mana curve). Low-curve aggro decks like Mono-Red or Burn can get away with 20&ndash;22 lands, especially if they run cheap cantrips. Midrange decks typically want 24 lands, while control and ramp strategies often play 25&ndash;27. Enter your mana curve into the calculator above for a personalized recommendation.</p>
                </details>

                <details>
                    <summary>How many lands for Commander / EDH?</summary>
                    <p>Commander decks (99 cards + commander) typically run 35&ndash;38 lands. The ratio is slightly different from 60-card formats because of the larger deck size and singleton restriction. Decks with a low mana curve and lots of mana rocks can go as low as 33, while 4+ color decks or landfall strategies may want 38&ndash;40. Don&rsquo;t forget to count mana-producing artifacts like Sol Ring and signets when planning your mana base.</p>
                </details>

                <details>
                    <summary>What is Frank Karsten's mana math?</summary>
                    <p>Frank Karsten&rsquo;s mana math is the gold standard for calculating MTG mana bases. Using hypergeometric probability, Karsten determined exactly how many colored sources you need to cast your spells on curve with approximately 90% consistency. For example, a card costing 1WW in a 60-card deck needs about 18 white sources. His research, published on ChannelFireball, is the foundation used by competitive players and this calculator.</p>
                </details>

                <details>
                    <summary>How many colored sources do I need?</summary>
                    <p>The number of colored sources depends on how many pips of that color appear in your casting costs and what turn you need them. Karsten&rsquo;s guidelines for a 60-card deck: a single colored pip on turn 1 needs ~14 sources, a single pip on turn 3 needs ~12, and double pips (like 1WW) need ~18 sources. This calculator does the math automatically &mdash; just input your colored mana symbols and it computes the sources needed per color.</p>
                </details>

                <details>
                    <summary>What is the 40% rule for lands?</summary>
                    <p>The &ldquo;40% rule&rdquo; is a rough guideline that suggests about 40% of your deck should be lands. For a 60-card deck that&rsquo;s 24 lands, and for a 40-card Limited deck that&rsquo;s 16&ndash;17 lands. While this rule of thumb works as a starting point, the actual number should depend on your mana curve. Aggressive decks with lots of 1&ndash;2 drops can go below 40%, while control decks may want to stay at or above it.</p>
                </details>

                <details>
                    <summary>How do dual lands affect my mana base?</summary>
                    <p>Dual lands (lands that produce two or more colors) are crucial for multicolor decks because each one counts as a source for every color it produces. A Hallowed Fountain counts as both a white source and a blue source, reducing the total lands you need. Premium duals like shock lands and fetch lands are the most efficient because they enter untapped or have basic land types. This calculator&rsquo;s land suggestions section recommends specific dual land cycles based on your format and colors. See our complete <a href="/tools/lands/">dual lands reference guide</a> for every cycle by format.</p>
                </details>

                <details>
                    <summary>How many lands for a 3-color Commander deck?</summary>
                    <p>A three-color Commander deck typically runs 36&ndash;38 lands, but the real challenge is the color distribution. Each color needs at least 14&ndash;16 sources to reliably cast single-pip spells by turn 3. With three colors, you need heavy investment in multicolor lands: fetch lands, shock lands, triomes, and check lands that produce two of your three colors. Budget options include pain lands, filter lands, and the battlebond lands. Use this calculator with the Commander preset to see exactly how many sources of each color your 3-color deck requires.</p>
                </details>

                <details>
                    <summary>What is the mana curve and why does it matter for lands?</summary>
                    <p>The mana curve is the distribution of mana values (casting costs) across your nonland cards. It directly determines how many lands you need: a deck full of 1&ndash;2 drops can function on 22 lands, while a deck with lots of 4&ndash;6 drops needs 25+. The ideal curve depends on your strategy &mdash; aggro decks want a low curve peaking at 1&ndash;2, midrange peaks at 2&ndash;3, and control wants a flatter distribution with powerful top-end. Enter your curve into this mana base calculator to see exactly how your land count should scale.</p>
                </details>

                <details>
                    <summary>How do I calculate mana for Limited / Draft decks?</summary>
                    <p>For 40-card Limited decks (Draft and Sealed), the standard is 17 lands. The color split depends on your deck&rsquo;s pip distribution. A mostly-red deck splashing white might run 10 Mountains and 7 Plains, while an even two-color deck wants about 9/8 or 8/9. Use the Limited format preset in this calculator, enter your colored pips from your drafted cards, and it computes the optimal basic land split. Remember that in Limited, you rarely have dual lands, so your mana base is mostly basics.</p>
                </details>

                <details>
                    <summary>How does this mana calculator differ from other MTG land calculators?</summary>
                    <p>Most MTG land calculators only tell you how many total lands to run. This calculator goes further by implementing Frank Karsten&rsquo;s <strong>hypergeometric probability model</strong> &mdash; the same math used by Pro Tour players. It calculates the exact number of <em>colored sources</em> per color, shows your probability of casting each spell on curve, and recommends specific dual land cycles for your format. It also includes a decklist import feature that auto-detects your mana pips via Scryfall, so you can paste a deck and get instant results.</p>
                </details>

                <details>
                    <summary>Should I count mana rocks as colored sources?</summary>
                    <p>Mana rocks like Sol Ring, Arcane Signet, and Signets contribute to your mana production but are not technically &ldquo;lands.&rdquo; In Commander, mana rocks are essential &mdash; most decks run 8&ndash;12 ramp pieces. A rock that produces your color counts as roughly 0.5&ndash;0.75 of a colored source because it can be removed and doesn&rsquo;t affect your opening hand land count. The safe approach: build your land base as if rocks don&rsquo;t exist, then add rocks on top as acceleration. This calculator focuses on lands specifically, since they&rsquo;re the foundation.</p>
                </details>
            </section>

            <!-- Related Tools -->
            <div class="info-box" style="margin-top:1.5rem;">
                <h3>&#128736; Related Mana Base Tools</h3>
                <p>
                    <strong><a href="/tools/lands/">Dual Lands Reference Guide</a></strong> &mdash; Browse every dual land cycle in Magic, filtered by color, speed, and format legality. See which lands are legal in Standard, Pioneer, Modern, and Commander.<br>
                    <strong><a href="/tools/commander-bracket/">Commander Bracket Calculator</a></strong> &mdash; Analyze your Commander deck&rsquo;s power level. Detects fast mana, tutors, combo pieces, and estimates your bracket rating.<br>
                    <strong><a href="/guides/commander-deck-building.html">Commander Deck Building Guide</a></strong> &mdash; Complete guide to building EDH decks, including mana base theory, color ratios, and ramp packages.<br>
                    <strong><a href="/tools/hypergeometric/">Hypergeometric Calculator</a></strong> &mdash; Raw probability calculator for any MTG scenario. Compute draw odds for any card or combination.<br>
                    <strong><a href="/draft/">Draft Simulator</a></strong> &mdash; Practice drafting against 7 AI opponents with real set cards. Build your deck and export to Arena.<br>
                    <strong><a href="/tools/sealed/">Sealed Pool Simulator</a></strong> &mdash; Open 6 virtual booster packs and build a 40-card sealed deck. Practice for prerelease events.
                </p>
            </div>
        </div>
    </main>

    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-logo">ScrollVault</div>
                <div class="wubrg-dots">
                    <span class="mana-dot" style="background: #F9FAF4"></span>
                    <span class="mana-dot" style="background: #0E68AB"></span>
                    <span class="mana-dot" style="background: #150B00; border: 1px solid rgba(255,255,255,0.2)"></span>
                    <span class="mana-dot" style="background: #D3202A"></span>
                    <span class="mana-dot" style="background: #00733E"></span>
                </div>
                <p class="footer-text">&copy; 2026 scrollvault.net. Magic: The Gathering is a trademark of Wizards of the Coast. Card images &copy; Wizards of the Coast via Scryfall.</p>
                <ul class="footer-links">
                    <li><a href="/privacy.html">Privacy Policy</a></li>
                    <li><a href="/terms.html">Terms of Service</a></li>
                    <li><a href="/contact.html">Contact</a></li>
                    <li><a href="/about/authors.html">Authors</a></li>
                    <li><a href="/about/editorial-policy.html">Editorial Policy</a></li>
                </ul>
            </div>
        </div>
    </footer>

<script>
/* ══════════════════════════════════════════
   Mana Base Calculator - ScrollVault
   ══════════════════════════════════════════ */

// ── State ──
const COLORS = ['W', 'U', 'B', 'R', 'G'];
const COLOR_NAMES = { W: 'White', U: 'Blue', B: 'Black', R: 'Red', G: 'Green' };
const COLOR_HEX = { W: '#F9FAF4', U: '#0E68AB', B: '#555', R: '#D3202A', G: '#00733E' };
const COLOR_TEXT = { W: '#333', U: '#fff', B: '#ccc', R: '#fff', G: '#fff' };

let state = {
    format: 'standard',
    deckSize: 60,
    totalLands: 24,
    activeColors: new Set(['W', 'U']),
    pips: { W: 12, U: 12, B: 0, R: 0, G: 0 },
    curve: [0, 8, 10, 8, 6, 3, 1, 0],
    mode: 'manual',       // 'manual' | 'imported'
    cards: null,           // [{name, qty, mv, pips, isLand, producesColors}]
    simResults: null       // from worker
};

// Simulation worker
var simWorker = null;
var simWorkerFailed = false;

// ── Comprehensive Dual Land Database ──
// Each cycle: name, short description, tier (1=premium, 2=good, 3=budget), cards per color pair
const LAND_CYCLES = {
    // --- STANDARD-LEGAL ---
    shockLands: { name: 'Shock Lands', desc: 'Pay 2 life or ETB tapped. Fetchable (has basic land types).', tier: 1, cards: {
        WU:'Hallowed Fountain', WB:'Godless Shrine', WR:'Sacred Foundry', WG:'Temple Garden',
        UB:'Watery Grave', UR:'Steam Vents', UG:'Breeding Pool', BR:'Blood Crypt', BG:'Overgrown Tomb', RG:'Stomping Ground' }},
    surveilLands: { name: 'Surveil Lands', desc: 'ETB tapped. Surveil 1. Fetchable (has basic land types).', tier: 1, cards: {
        WU:'Meticulous Archive', WB:'Shadowy Backstreet', WR:'Elegant Parlor', WG:'Lush Portico',
        UB:'Undercity Sewers', UR:'Thundering Falls', UG:'Hedge Maze', BR:'Raucous Theater', BG:'Underground Mortuary', RG:'Commercial District' }},
    fastLandsEnemy: { name: 'Fast Lands (Enemy)', desc: 'ETB untapped if you control 2 or fewer lands.', tier: 1, cards: {
        WB:'Concealed Courtyard', UR:'Spirebluff Canal', BG:'Blooming Marsh', WR:'Inspiring Vantage', UG:'Botanical Sanctum' }},
    vergeLands: { name: 'Verge Lands', desc: 'ETB untapped. Second color requires matching basic land type.', tier: 1, cards: {
        WU:'Floodfarm Verge', UB:'Gloomlake Verge', BR:'Blazemire Verge', RG:'Thornspire Verge', WG:'Hushwood Verge',
        WB:'Bleachbone Verge', UR:'Riverpyre Verge', BG:'Wastewood Verge', WR:'Sunbillow Verge', UG:'Willowrush Verge' }},
    hauntLands: { name: 'Haunt Lands', desc: 'ETB tapped unless a player has 13 or less life.', tier: 2, cards: {
        WU:'Abandoned Campground', UB:'Murky Sewer', BR:'Razortrap Gorge', RG:'Bleeding Woods', WG:'Etched Cornfield',
        WB:'Neglected Manor', UR:'Peculiar Lighthouse', BG:'Strangled Cemetery', WR:'Raucous Carnival', UG:'Lakeside Shack' }},
    restlessLands: { name: 'Restless Creature Lands', desc: 'ETB tapped. Can animate into a creature.', tier: 2, cards: {
        WU:'Restless Anchorage', WB:'Restless Fortress', WR:'Restless Bivouac', WG:'Restless Prairie',
        UB:'Restless Reef', UR:'Restless Spire', UG:'Restless Vinestalk', BR:'Restless Vents', BG:'Restless Cottage', RG:'Restless Ridgeline' }},
    scryTemples: { name: 'Scry Temples', desc: 'ETB tapped. Scry 1.', tier: 3, cards: {
        WU:'Temple of Enlightenment', WB:'Temple of Silence', WR:'Temple of Triumph', WG:'Temple of Plenty',
        UB:'Temple of Deceit', UR:'Temple of Epiphany', UG:'Temple of Mystery', BR:'Temple of Malice', BG:'Temple of Malady', RG:'Temple of Abandon' }},
    gainLands: { name: 'Gain Lands', desc: 'ETB tapped. Gain 1 life.', tier: 3, cards: {
        WU:'Tranquil Cove', WB:'Scoured Barrens', WR:'Wind-Scarred Crag', WG:'Blossoming Sands',
        UB:'Dismal Backwater', UR:'Swiftwater Cliffs', UG:'Thornwood Falls', BR:'Bloodfell Caves', BG:'Jungle Hollow', RG:'Rugged Highlands' }},
    guildgates: { name: 'Guildgates', desc: 'ETB tapped. Gate subtype.', tier: 3, cards: {
        WU:'Azorius Guildgate', WB:'Orzhov Guildgate', WR:'Boros Guildgate', WG:'Selesnya Guildgate',
        UB:'Dimir Guildgate', UR:'Izzet Guildgate', UG:'Simic Guildgate', BR:'Rakdos Guildgate', BG:'Golgari Guildgate', RG:'Gruul Guildgate' }},

    // --- PIONEER-ONLY (not in current Standard) ---
    checkLands: { name: 'Check Lands', desc: 'ETB untapped if you control a matching basic land type.', tier: 1, cards: {
        WU:'Glacial Fortress', WB:'Isolated Chapel', WR:'Clifftop Retreat', WG:'Sunpetal Grove',
        UB:'Drowned Catacomb', UR:'Sulfur Falls', UG:'Hinterland Harbor', BR:'Dragonskull Summit', BG:'Woodland Cemetery', RG:'Rootbound Crag' }},
    pathwayLands: { name: 'Pathway Lands', desc: 'MDFC. Choose a side (untapped, one color once played).', tier: 2, cards: {
        WU:'Hengegate Pathway', WB:'Brightclimb Pathway', WR:'Needleverge Pathway', WG:'Branchloft Pathway',
        UB:'Clearwater Pathway', UR:'Riverglide Pathway', UG:'Barkchannel Pathway', BR:'Blightstep Pathway', BG:'Darkbore Pathway', RG:'Cragcrown Pathway' }},
    slowLands: { name: 'Slow Lands', desc: 'ETB untapped if you control 2+ other lands.', tier: 1, cards: {
        WU:'Deserted Beach', WB:'Shattered Sanctum', WR:'Sundown Pass', WG:'Overgrown Farmland',
        UB:'Shipwreck Marsh', UR:'Stormcarved Coast', UG:'Dreamroot Cascade', BR:'Haunted Ridge', BG:'Deathcap Glade', RG:'Rockfall Vale' }},
    painLands: { name: 'Pain Lands', desc: 'ETB untapped. 1 damage for colored mana, free colorless.', tier: 1, cards: {
        WU:'Adarkar Wastes', WB:'Caves of Koilos', WR:'Battlefield Forge', WG:'Brushland',
        UB:'Underground River', UR:'Shivan Reef', UG:'Yavimaya Coast', BR:'Sulfurous Springs', BG:'Llanowar Wastes', RG:'Karplusan Forest' }},
    revealLands: { name: 'Reveal Lands', desc: 'ETB untapped if you reveal a matching basic from hand.', tier: 2, cards: {
        WU:'Port Town', WB:'Shineshadow Snarl', WR:'Furycalm Snarl', WG:'Fortified Village',
        UB:'Choked Estuary', UR:'Frostboil Snarl', UG:'Vineglimmer Snarl', BR:'Foreboding Ruins', BG:'Necroblossom Snarl', RG:'Game Trail' }},

    // --- MODERN-ONLY ---
    fetchLands: { name: 'Fetch Lands', desc: 'Pay 1 life, sac: search for a land with basic land type.', tier: 1, cards: {
        WU:'Flooded Strand', WB:'Marsh Flats', WR:'Arid Mesa', WG:'Windswept Heath',
        UB:'Polluted Delta', UR:'Scalding Tarn', UG:'Misty Rainforest', BR:'Bloodstained Mire', BG:'Verdant Catacombs', RG:'Wooded Foothills' }},
    fastLands: { name: 'Fast Lands', desc: 'ETB untapped if you control 2 or fewer lands.', tier: 1, cards: {
        WU:'Seachrome Coast', WB:'Concealed Courtyard', WR:'Inspiring Vantage', WG:'Razorverge Thicket',
        UB:'Darkslick Shores', UR:'Spirebluff Canal', UG:'Botanical Sanctum', BR:'Blackcleave Cliffs', BG:'Blooming Marsh', RG:'Copperline Gorge' }},
    horizonLands: { name: 'Horizon Lands', desc: 'Tap for color (1 dmg). Sac + pay 1 life: draw a card.', tier: 1, cards: {
        WB:'Silent Clearing', WG:'Horizon Canopy', WR:'Sunbaked Canyon', UR:'Fiery Islet', UG:'Waterlogged Grove', BG:'Nurturing Peatland' }},
    filterLands: { name: 'Filter Lands', desc: 'Tap for colorless. Or pay {1} color to get 2 mana in combo.', tier: 2, cards: {
        WU:'Mystic Gate', WB:'Fetid Heath', WR:'Rugged Prairie', WG:'Wooded Bastion',
        UB:'Sunken Ruins', UR:'Cascade Bluffs', UG:'Flooded Grove', BR:'Graven Cairns', BG:'Twilight Mire', RG:'Fire-Lit Thicket' }},

    // --- LEGACY-ONLY ---
    originalDuals: { name: 'Original Dual Lands', desc: 'No drawback. Two basic land types. Reserved List.', tier: 1, cards: {
        WU:'Tundra', WB:'Scrubland', WR:'Plateau', WG:'Savannah',
        UB:'Underground Sea', UR:'Volcanic Island', UG:'Tropical Island', BR:'Badlands', BG:'Bayou', RG:'Taiga' }},

    // --- COMMANDER ---
    bondLands: { name: 'Bond Lands', desc: 'ETB untapped if you have 2+ opponents.', tier: 1, cards: {
        WU:'Sea of Clouds', WB:'Vault of Champions', WR:'Spectator Seating', WG:'Bountiful Promenade',
        UB:'Morphic Pool', UR:'Training Center', UG:'Rejuvenating Springs', BR:'Luxury Suite', BG:'Undergrowth Stadium', RG:'Spire Garden' }}
};

// Which cycles are available in each format, in priority order (best first)
const FORMAT_CYCLE_KEYS = {
    standard: ['shockLands','fastLandsEnemy','vergeLands','surveilLands','hauntLands','restlessLands','scryTemples','gainLands','guildgates'],
    pioneer:  ['shockLands','fastLandsEnemy','painLands','checkLands','slowLands','vergeLands','surveilLands','pathwayLands','revealLands','hauntLands','restlessLands','scryTemples'],
    modern:   ['fetchLands','shockLands','fastLands','horizonLands','painLands','checkLands','filterLands','slowLands','surveilLands','pathwayLands','restlessLands','scryTemples'],
    legacy:   ['fetchLands','originalDuals','shockLands','fastLands','horizonLands','painLands','checkLands','filterLands','slowLands','surveilLands'],
    limited:  ['gainLands','guildgates','scryTemples'],
    commander:['shockLands','fetchLands','bondLands','painLands','checkLands','fastLands','slowLands','filterLands','surveilLands','restlessLands','scryTemples'],
    custom:   ['shockLands','fastLands','painLands','checkLands']
};

// ══════════════════════════════════════════
// Hypergeometric Probability (logChoose)
// ══════════════════════════════════════════

function logFactorial(n) {
    // Stirling's approximation for large n, exact for small n
    if (n < 0) return 0;
    if (n <= 1) return 0;
    if (n < 20) {
        let result = 0;
        for (let i = 2; i <= n; i++) result += Math.log(i);
        return result;
    }
    // Stirling's approximation
    return n * Math.log(n) - n + 0.5 * Math.log(2 * Math.PI * n) + 1/(12*n) - 1/(360*n*n*n);
}

function logChoose(n, k) {
    if (k < 0 || k > n) return -Infinity;
    if (k === 0 || k === n) return 0;
    return logFactorial(n) - logFactorial(k) - logFactorial(n - k);
}

function hypergeometricPMF(x, N, K, n) {
    // P(X = x) where:
    // N = population size (deck size)
    // K = successes in population (colored sources)
    // n = draws (cards drawn by turn)
    // x = successes in draws (colored sources drawn)
    if (x < 0 || x > Math.min(K, n) || x < Math.max(0, n - (N - K))) return 0;
    var logP = logChoose(K, x) + logChoose(N - K, n - x) - logChoose(N, n);
    return Math.exp(logP);
}

function hypergeometricCDF_atLeast(k, N, K, n) {
    // P(X >= k): probability of drawing at least k successes
    if (k <= 0) return 1;
    if (k > Math.min(K, n)) return 0;
    // Sum P(X = i) for i from k to min(K, n)
    var maxX = Math.min(K, n);
    var sum = 0;
    for (var i = k; i <= maxX; i++) {
        sum += hypergeometricPMF(i, N, K, n);
    }
    return Math.min(1, Math.max(0, sum));
}

// ══════════════════════════════════════════
// Karsten's land recommendation
// ══════════════════════════════════════════

// Real Karsten table: key = "pips-turn", value = sources needed in 60-card deck at 90% confidence
// From Frank Karsten's ChannelFireball research
var KARSTEN_TABLE = {
    '1-1':14, '1-2':13, '1-3':12, '1-4':10, '1-5':9, '1-6':9,
    '2-2':20, '2-3':18, '2-4':16, '2-5':15, '2-6':13,
    '3-3':23, '3-4':21, '3-5':19, '3-6':17,
    '4-4':24, '4-5':22, '4-6':20
};

function karstenLookup(pips, turn) {
    // Look up sources needed for `pips` colored pips at `turn` in 60-card deck
    if (pips <= 0) return 0;
    var clampedPips = Math.min(pips, 4);
    var clampedTurn = Math.max(clampedPips, Math.min(turn, 6));
    var key = clampedPips + '-' + clampedTurn;
    return KARSTEN_TABLE[key] || Math.min(14 + (clampedPips - 1) * 4, 24);
}

function findMostDemandingCard(color, cards) {
    // Find the card with the most pips of this color at the lowest MV
    // Returns {pips, turn} or null
    var best = null;
    if (!cards) return null;
    for (var i = 0; i < cards.length; i++) {
        var card = cards[i];
        if (card.isLand) continue;
        var colorPips = card.pips[color] || 0;
        if (colorPips <= 0) continue;
        var turn = card.mv;
        if (turn < 1) turn = 1;
        // More demanding = more pips or same pips at lower turn
        if (!best || colorPips > best.pips || (colorPips === best.pips && turn < best.turn)) {
            best = { pips: colorPips, turn: turn };
        }
    }
    return best;
}

function recommendedSources(color, deckSize, totalLands, cards) {
    // Per-card Karsten method: find the most demanding card for this color
    var demand = findMostDemandingCard(color, cards);
    if (!demand) {
        // Fallback for manual mode: estimate from aggregate pips
        return recommendedSourcesFromPips(state.pips[color], deckSize, totalLands);
    }
    var base60 = karstenLookup(demand.pips, demand.turn);
    // Scale for non-60-card decks
    var scaleFactor = deckSize / 60;
    return Math.max(1, Math.round(base60 * scaleFactor));
}

function recommendedSourcesFromPips(totalPips, deckSize, totalLands) {
    // Fallback for manual mode: estimate from aggregate pip count
    // Use heuristic: map total pips to an approximate "most demanding" requirement
    if (totalPips <= 0) return 0;
    var totalSpells = state.curve.reduce(function(a, b) { return a + b; }, 0);
    if (totalSpells === 0) return Math.max(1, Math.round(totalPips * 0.7));

    // Estimate: average pips per spell with this color, and earliest turn needed
    var avgPipsPerSpell = totalPips / totalSpells;
    var estMaxPips = Math.min(4, Math.ceil(avgPipsPerSpell * 2));
    // Find earliest MV with spells
    var earliestTurn = 7;
    for (var mv = 1; mv <= 7; mv++) {
        if (state.curve[mv] > 0) { earliestTurn = mv; break; }
    }
    var base60 = karstenLookup(Math.max(1, estMaxPips), earliestTurn);
    var scaleFactor = deckSize / 60;
    return Math.max(1, Math.round(base60 * scaleFactor));
}

// ══════════════════════════════════════════
// UI Initialization
// ══════════════════════════════════════════

// Slug → JS cycle key mapping (JSON uses slugs, JS uses camelCase)
const SLUG_TO_KEYS = {
  'shock-lands':    ['shockLands'],
  'survey-lands':   ['surveilLands'],
  'fast-lands':     ['fastLandsEnemy', 'fastLands'],
  'verge-lands':    ['vergeLands'],
  'haunt-lands':    ['hauntLands'],
  'restless-lands': ['restlessLands'],
  'scry-lands':     ['scryTemples'],
  'gain-lands':     ['gainLands'],
  'guildgates':     ['guildgates'],
  'check-lands':    ['checkLands'],
  'pathway-lands':  ['pathwayLands'],
  'slow-lands':     ['slowLands'],
  'pain-lands':     ['painLands'],
  'reveal-lands':   ['revealLands'],
  'fetch-lands':    ['fetchLands'],
  'horizon-lands':  ['horizonLands'],
  'filter-lands':   ['filterLands'],
  'original-duals': ['originalDuals'],
  'bond-lands':     ['bondLands']
};
// Tier-priority ordering: premium first, budget last
const TIER_ORDER = [
  'fetchLands','originalDuals','shockLands','fastLands','fastLandsEnemy',
  'horizonLands','bondLands','painLands','checkLands','slowLands',
  'vergeLands','filterLands','surveilLands','pathwayLands','revealLands',
  'hauntLands','restlessLands','scryTemples','gainLands','guildgates'
];

function loadLandLegality() {
  fetch('/data/land-legality.json')
    .then(function(r) { return r.ok ? r.json() : Promise.reject(); })
    .then(function(data) {
      if (!data || !data.cycles) return;
      // Build reverse map: JS key → legal formats
      var keyLegal = {};
      for (var slug in data.cycles) {
        var jsKeys = SLUG_TO_KEYS[slug];
        if (!jsKeys) continue;
        for (var i = 0; i < jsKeys.length; i++) {
          keyLegal[jsKeys[i]] = data.cycles[slug];
        }
      }
      // Rebuild FORMAT_CYCLE_KEYS for each format
      var fmts = ['standard','pioneer','modern','legacy','commander'];
      for (var f = 0; f < fmts.length; f++) {
        var fmt = fmts[f];
        var keys = [];
        for (var t = 0; t < TIER_ORDER.length; t++) {
          var k = TIER_ORDER[t];
          if (LAND_CYCLES[k] && keyLegal[k] && keyLegal[k][fmt]) {
            keys.push(k);
          }
        }
        if (keys.length > 0) FORMAT_CYCLE_KEYS[fmt] = keys;
      }
    })
    .catch(function() {}); // Keep hardcoded fallback
}

function init() {
    initWorker();
    setupFormatButtons();
    setupColorToggles();
    renderPipInputs();
    setupCurveListeners();
    updateCurveTotal();
    loadLandLegality();
}

function setupFormatButtons() {
    var btns = document.querySelectorAll('.format-btn');
    btns.forEach(function(btn) {
        btn.addEventListener('click', function() {
            btns.forEach(function(b) { b.classList.remove('active'); });
            btn.classList.add('active');
            state.format = btn.dataset.format;
            if (btn.dataset.format !== 'custom') {
                var ds = parseInt(btn.dataset.deck);
                var tl = parseInt(btn.dataset.lands);
                state.deckSize = ds;
                state.totalLands = tl;
                document.getElementById('deckSize').value = ds;
                document.getElementById('totalLands').value = tl;
                updateCurveTotal();
            }
        });
    });
}

function setupColorToggles() {
    var toggles = document.querySelectorAll('.color-toggle');
    toggles.forEach(function(t) {
        t.addEventListener('click', function() {
            var c = t.dataset.color;
            if (state.activeColors.has(c)) {
                state.activeColors.delete(c);
                t.classList.remove('active');
            } else {
                state.activeColors.add(c);
                t.classList.add('active');
            }
            renderPipInputs();
        });
    });
}

function renderPipInputs() {
    var section = document.getElementById('pipSection');
    section.innerHTML = '';
    if (state.activeColors.size === 0) {
        section.innerHTML = '<p style="color:var(--text-muted);font-size:0.85rem;text-align:center;padding:1rem 0;">Select at least one color above.</p>';
        return;
    }
    COLORS.forEach(function(c) {
        if (!state.activeColors.has(c)) {
            state.pips[c] = 0;
            return;
        }
        var row = document.createElement('div');
        row.className = 'pip-row';

        var dot = document.createElement('div');
        dot.className = 'pip-color-dot';
        dot.style.background = COLOR_HEX[c];
        if (c === 'B') dot.style.border = '1px solid rgba(255,255,255,0.2)';
        dot.style.color = COLOR_TEXT[c];
        dot.textContent = c;

        var label = document.createElement('div');
        label.className = 'pip-label';
        label.textContent = COLOR_NAMES[c] + ' pips';

        var controls = document.createElement('div');
        controls.className = 'pip-controls';

        var minBtn = document.createElement('button');
        minBtn.className = 'pip-btn';
        minBtn.textContent = '-';
        minBtn.setAttribute('data-color', c);
        minBtn.setAttribute('data-dir', '-1');
        minBtn.addEventListener('click', function() { adjustPip(c, -1); });

        var val = document.createElement('input');
        val.className = 'pip-value';
        val.type = 'number';
        val.min = '0';
        val.max = '99';
        val.value = state.pips[c];
        val.id = 'pip-' + c;
        val.addEventListener('change', function() {
            state.pips[c] = Math.max(0, parseInt(val.value) || 0);
        });

        var plusBtn = document.createElement('button');
        plusBtn.className = 'pip-btn';
        plusBtn.textContent = '+';
        plusBtn.addEventListener('click', function() { adjustPip(c, 1); });

        controls.appendChild(minBtn);
        controls.appendChild(val);
        controls.appendChild(plusBtn);

        row.appendChild(dot);
        row.appendChild(label);
        row.appendChild(controls);
        section.appendChild(row);
    });
}

function adjustPip(color, delta) {
    var input = document.getElementById('pip-' + color);
    var val = Math.max(0, (parseInt(input.value) || 0) + delta);
    input.value = val;
    state.pips[color] = val;
}

function setupCurveListeners() {
    var inputs = document.querySelectorAll('#curveInputs input');
    inputs.forEach(function(inp) {
        inp.addEventListener('input', function() {
            var mv = parseInt(inp.dataset.mv);
            state.curve[mv] = Math.max(0, parseInt(inp.value) || 0);
            updateCurveTotal();
        });
    });

    document.getElementById('deckSize').addEventListener('input', function() {
        state.deckSize = Math.max(20, parseInt(this.value) || 60);
        // Switch to custom format
        selectCustomFormat();
        updateCurveTotal();
    });

    document.getElementById('totalLands').addEventListener('input', function() {
        state.totalLands = Math.max(0, parseInt(this.value) || 0);
        selectCustomFormat();
        updateCurveTotal();
    });
}

function selectCustomFormat() {
    var btns = document.querySelectorAll('.format-btn');
    var isPreset = false;
    btns.forEach(function(b) {
        if (b.dataset.format !== 'custom' && parseInt(b.dataset.deck) === state.deckSize && parseInt(b.dataset.lands) === state.totalLands) {
            isPreset = true;
        }
    });
    if (!isPreset) {
        btns.forEach(function(b) { b.classList.remove('active'); });
        document.querySelector('.format-btn[data-format="custom"]').classList.add('active');
        state.format = 'custom';
    }
}

function updateCurveTotal() {
    var spells = state.curve.reduce(function(a, b) { return a + b; }, 0);
    var total = spells + state.totalLands;
    var el = document.getElementById('curveTotal');
    var mismatch = total !== state.deckSize;
    el.innerHTML = 'Spells: <strong>' + spells + '</strong> / Lands: <strong>' + state.totalLands + '</strong> / Total: <strong' + (mismatch ? ' style="color:#f87171"' : '') + '>' + total + '</strong>' + (mismatch ? ' <span style="color:#f87171;font-size:0.75rem;">(expected ' + state.deckSize + ')</span>' : '');
}

// ══════════════════════════════════════════
// Calculation
// ══════════════════════════════════════════

function calculate(fromImport) {
    // Read latest state
    state.deckSize = Math.max(20, parseInt(document.getElementById('deckSize').value) || 60);
    state.totalLands = Math.max(0, parseInt(document.getElementById('totalLands').value) || 0);
    COLORS.forEach(function(c) {
        var inp = document.getElementById('pip-' + c);
        if (inp) state.pips[c] = Math.max(0, parseInt(inp.value) || 0);
    });

    // Reset to manual mode if not coming from import
    if (!fromImport) {
        state.mode = 'manual';
        state.cards = null;
        state.simResults = null;
    }

    var activeList = COLORS.filter(function(c) { return state.activeColors.has(c) && state.pips[c] > 0; });

    if (activeList.length === 0) {
        showEmptyResults('Select at least one color and enter mana pips to calculate.');
        return;
    }

    // Calculate recommended sources per color
    var recommended = {};
    var totalRecommended = 0;
    activeList.forEach(function(c) {
        recommended[c] = recommendedSources(c, state.deckSize, state.totalLands, state.cards);
        totalRecommended += recommended[c];
    });

    // If total recommended > total lands, scale down proportionally
    if (totalRecommended > state.totalLands && totalRecommended > 0) {
        var scale = state.totalLands / totalRecommended;
        activeList.forEach(function(c) {
            recommended[c] = Math.max(1, Math.round(recommended[c] * scale));
        });
        // Adjust rounding to match exactly
        var newTotal = 0;
        activeList.forEach(function(c) { newTotal += recommended[c]; });
        var diff = state.totalLands - newTotal;
        // Distribute remainder to colors with most pips
        var sorted = activeList.slice().sort(function(a, b) { return state.pips[b] - state.pips[a]; });
        var i = 0;
        while (diff > 0 && i < sorted.length) { recommended[sorted[i]]++; diff--; i++; }
        while (diff < 0 && i < sorted.length) {
            if (recommended[sorted[i]] > 1) { recommended[sorted[i]]--; diff++; }
            i++;
        }
    }

    // If total recommended < total lands, remaining are colorless/utility
    var colorlessLands = Math.max(0, state.totalLands - activeList.reduce(function(s, c) { return s + recommended[c]; }, 0));

    // Build results HTML
    var html = '';

    // ── Land Count Cards ──
    html += '<h3>Recommended Land Sources</h3>';
    html += '<div class="land-counts">';
    activeList.forEach(function(c) {
        var pct = state.totalLands > 0 ? Math.round((recommended[c] / state.totalLands) * 100) : 0;
        html += '<div class="land-card" data-color="' + c + '">';
        html += '<div class="land-count">' + recommended[c] + '</div>';
        html += '<div class="land-label">' + COLOR_NAMES[c] + ' Sources</div>';
        html += '<div class="land-pct">' + pct + '% of lands</div>';
        html += '</div>';
    });
    if (colorlessLands > 0) {
        var pct = Math.round((colorlessLands / state.totalLands) * 100);
        html += '<div class="land-card" data-color="C">';
        html += '<div class="land-count">' + colorlessLands + '</div>';
        html += '<div class="land-label">Colorless / Utility</div>';
        html += '<div class="land-pct">' + pct + '% of lands</div>';
        html += '</div>';
    }
    html += '</div>';

    // ── Bar Chart ──
    html += '<div class="chart-section">';
    html += '<h3>Land Distribution</h3>';
    html += '<div class="bar-chart">';
    var maxCount = 0;
    activeList.forEach(function(c) { if (recommended[c] > maxCount) maxCount = recommended[c]; });
    if (colorlessLands > maxCount) maxCount = colorlessLands;
    if (maxCount === 0) maxCount = 1;

    activeList.forEach(function(c) {
        var h = Math.round((recommended[c] / maxCount) * 120);
        html += '<div class="bar-col">';
        html += '<div class="bar-count">' + recommended[c] + '</div>';
        html += '<div class="bar-fill" data-color="' + c + '" style="height:' + h + 'px"></div>';
        html += '<div class="bar-label">' + COLOR_NAMES[c] + '</div>';
        html += '</div>';
    });
    if (colorlessLands > 0) {
        var h = Math.round((colorlessLands / maxCount) * 120);
        html += '<div class="bar-col">';
        html += '<div class="bar-count">' + colorlessLands + '</div>';
        html += '<div class="bar-fill" data-color="C" style="height:' + h + 'px"></div>';
        html += '<div class="bar-label">Colorless</div>';
        html += '</div>';
    }
    html += '</div></div>';

    // ── Cast Rate / Probability Section ──
    html += '<div class="prob-section" id="simSection">';
    html += '<h3>Cast Rate Analysis</h3>';
    if (simWorkerFailed) {
        html += '<div class="sim-fallback-notice">Simulation unavailable &mdash; showing estimated probabilities (hypergeometric).</div>';
        html += renderFallbackProbTable(activeList, recommended);
    } else {
        html += '<div class="sim-progress" id="simProgress">';
        html += '<div class="sim-progress-bar" id="simProgressBar" style="width:0%"></div>';
        html += '<span class="sim-progress-text" id="simProgressText">Starting simulation...</span>';
        html += '</div>';
        html += '<div id="simResultsContainer"></div>';
    }
    html += '</div>';

    // ── Suggested Mana Base ──
    html += '<div class="suggested-section">';
    html += '<h3>Suggested Mana Base</h3>';

    // Calculate dual land suggestions
    if (activeList.length >= 2) {
        html += buildDualSuggestions(activeList, recommended, colorlessLands);
    } else {
        // Mono color
        var c = activeList[0];
        html += '<div class="suggest-card">';
        html += '<h4>Mono-' + COLOR_NAMES[c] + '</h4>';
        html += '<p>With a single color, your mana base is straightforward. Run ' + recommended[c] + ' basic ' + basicLandName(c) + 's';
        if (colorlessLands > 0) {
            html += ' and ' + colorlessLands + ' utility lands (e.g., Castle, creature lands, or colorless utility).';
        } else {
            html += '.';
        }
        html += '</p>';
        html += '<div class="suggest-lands">';
        html += '<span class="suggest-land"><span class="sl-count">' + recommended[c] + '</span> ' + basicLandName(c) + '</span>';
        if (colorlessLands > 0) {
            html += '<span class="suggest-land"><span class="sl-count">' + colorlessLands + '</span> Utility Lands</span>';
        }
        html += '</div></div>';
    }

    html += '</div>';

    document.getElementById('resultsContent').innerHTML = html;

    // Launch Monte Carlo simulation (unless worker failed)
    if (!simWorkerFailed) {
        launchSimulation(activeList, recommended);
    }

    // Scroll to results on mobile
    if (window.innerWidth <= 960) {
        document.getElementById('resultsPanel').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
}

// ══════════════════════════════════════════
// Monte Carlo Simulation Integration
// ══════════════════════════════════════════

function initWorker() {
    try {
        simWorker = new Worker('/tools/manabase/sim-worker.js');
        simWorker.onerror = function(e) {
            console.warn('Sim worker failed:', e.message);
            simWorkerFailed = true;
            if (simWorker) { simWorker.terminate(); simWorker = null; }
        };
    } catch (e) {
        console.warn('Cannot create Web Worker:', e.message);
        simWorkerFailed = true;
    }
}

function buildDeckSpec() {
    var spec = { size: state.deckSize, spells: [], lands: [] };

    if (state.mode === 'imported' && state.cards) {
        // Import mode: use actual per-card data
        for (var i = 0; i < state.cards.length; i++) {
            var card = state.cards[i];
            if (card.isLand) {
                spec.lands.push({ name: card.name, qty: card.qty, produces: card.producesColors || [] });
            } else {
                spec.spells.push({ name: card.name, qty: card.qty, mv: card.mv, pips: card.pips });
            }
        }
    } else {
        // Manual mode: synthesize virtual deck from pip counts and curve
        var activeList = COLORS.filter(function(c) { return state.activeColors.has(c) && state.pips[c] > 0; });
        var totalPipCount = 0;
        activeList.forEach(function(c) { totalPipCount += state.pips[c]; });

        // Create virtual spells for each MV slot
        for (var mv = 1; mv <= 7; mv++) {
            var spellCount = state.curve[mv] || 0;
            if (spellCount <= 0) continue;

            // Distribute pips proportionally across this MV
            var virtualPips = {};
            activeList.forEach(function(c) {
                if (totalPipCount > 0) {
                    virtualPips[c] = Math.min(mv, Math.round(state.pips[c] / totalPipCount * Math.min(mv, 2)));
                } else {
                    virtualPips[c] = 0;
                }
            });
            // Ensure at least 1 total colored pip
            var pipSum = 0;
            for (var c in virtualPips) pipSum += virtualPips[c];
            if (pipSum === 0 && activeList.length > 0) virtualPips[activeList[0]] = 1;

            spec.spells.push({ name: mv + '-drop', qty: spellCount, mv: mv, pips: virtualPips });
        }

        // Add 0-MV spells if any
        if (state.curve[0] > 0) {
            spec.spells.push({ name: '0-drop', qty: state.curve[0], mv: 0, pips: { W:0, U:0, B:0, R:0, G:0 } });
        }

        // Lands: basics from recommended sources, distribute by pip proportion
        var totalLands = state.totalLands;
        activeList.forEach(function(c) {
            var count = Math.round(totalLands * (state.pips[c] / Math.max(1, totalPipCount)));
            if (count > 0) {
                spec.lands.push({ name: basicLandName(c), qty: count, produces: [c] });
            }
        });

        // Remaining lands as colorless
        var assignedLands = spec.lands.reduce(function(s, l) { return s + l.qty; }, 0);
        var remaining = totalLands - assignedLands;
        if (remaining > 0) {
            spec.lands.push({ name: 'Utility Land', qty: remaining, produces: [] });
        }
    }

    return spec;
}

function launchSimulation(activeList, recommended) {
    if (!simWorker || simWorkerFailed) return;

    var deckSpec = buildDeckSpec();

    // If deck spec is too small, skip simulation
    var totalCards = 0;
    deckSpec.spells.forEach(function(s) { totalCards += s.qty; });
    deckSpec.lands.forEach(function(l) { totalCards += l.qty; });
    if (totalCards < 10) return;

    simWorker.onmessage = function(e) {
        if (e.data.type === 'progress') {
            var pct = Math.round((e.data.iteration / e.data.total) * 100);
            var bar = document.getElementById('simProgressBar');
            var text = document.getElementById('simProgressText');
            if (bar) bar.style.width = pct + '%';
            if (text) text.textContent = 'Simulating... ' + e.data.iteration.toLocaleString() + ' / ' + e.data.total.toLocaleString() + ' games';
        } else if (e.data.type === 'complete') {
            state.simResults = e.data.results;
            renderSimResults(e.data.results, activeList, recommended);
        }
    };

    simWorker.postMessage({
        type: 'simulate',
        deck: deckSpec,
        params: { iterations: 50000, progressInterval: 5000 }
    });
}

function renderSimResults(results, activeList, recommended) {
    var container = document.getElementById('simResultsContainer');
    var progress = document.getElementById('simProgress');
    if (!container) return;
    if (progress) progress.style.display = 'none';

    var html = '';

    // Summary
    var overallHits = 0, overallTrials = 0;
    results.perCard.forEach(function(card) {
        if (card.mv >= 1 && card.mv <= 7) {
            overallHits += card.castRate;
            overallTrials++;
        }
    });
    var overallRate = overallTrials > 0 ? (overallHits / overallTrials * 100).toFixed(1) : '0.0';
    html += '<div class="sim-summary">Simulated ' + results.iterations.toLocaleString() + ' games in ' + (results.elapsed / 1000).toFixed(1) + 's &mdash; Overall castability: <strong>' + overallRate + '%</strong></div>';

    // Cast rate table
    if (state.mode === 'imported' && state.cards) {
        // Per-card table
        html += '<div class="prob-table-wrapper"><table class="prob-table">';
        html += '<thead><tr><th style="text-align:left;">Card</th><th>Cost</th><th>Turn</th><th>Cast Rate</th></tr></thead><tbody>';
        results.perCard.forEach(function(card) {
            if (card.mv < 1) return;
            var pctStr = (card.castRate * 100).toFixed(1) + '%';
            var cls = card.castRate >= 0.9 ? 'prob-good' : (card.castRate >= 0.8 ? 'prob-ok' : 'prob-bad');
            var icon = card.castRate >= 0.9 ? ' &#10003;' : (card.castRate < 0.8 ? ' &#10007;' : '');
            html += '<tr>';
            html += '<td class="turn-col" style="text-align:left;">' + card.name + '</td>';
            html += '<td class="cast-mana">' + formatPips(card.pips) + '</td>';
            html += '<td>' + card.mv + '</td>';
            html += '<td class="' + cls + '">' + pctStr + icon + '</td>';
            html += '</tr>';
        });
        html += '</tbody></table></div>';
    } else {
        // Manual mode: per-color benchmark table
        html += '<div class="prob-table-wrapper"><table class="prob-table">';
        html += '<thead><tr><th style="text-align:left;">Color</th><th>Hardest Requirement</th><th>Turn</th><th>Cast Rate</th></tr></thead><tbody>';
        activeList.forEach(function(c) {
            // Find the matching virtual spell for this color
            var bestCard = null;
            results.perCard.forEach(function(card) {
                if (card.pips[c] > 0 && card.mv >= 1) {
                    if (!bestCard || card.pips[c] > bestCard.pips[c] || (card.pips[c] === bestCard.pips[c] && card.mv < bestCard.mv)) {
                        bestCard = card;
                    }
                }
            });
            if (!bestCard) return;
            var pctStr = (bestCard.castRate * 100).toFixed(1) + '%';
            var cls = bestCard.castRate >= 0.9 ? 'prob-good' : (bestCard.castRate >= 0.8 ? 'prob-ok' : 'prob-bad');
            var pipDesc = '{' + c + '}'.repeat(bestCard.pips[c]) + ' spell';
            html += '<tr>';
            html += '<td class="turn-col" style="text-align:left;color:' + COLOR_HEX[c] + ';">' + COLOR_NAMES[c] + '</td>';
            html += '<td class="cast-mana">' + pipDesc + '</td>';
            html += '<td>' + bestCard.mv + '</td>';
            html += '<td class="' + cls + '">' + pctStr + '</td>';
            html += '</tr>';
        });
        html += '</tbody></table></div>';
    }

    container.innerHTML = html;
}

function formatPips(pips) {
    var s = '';
    COLORS.forEach(function(c) {
        for (var i = 0; i < (pips[c] || 0); i++) {
            s += '{' + c + '}';
        }
    });
    return s || '{C}';
}

function renderFallbackProbTable(activeList, recommended) {
    // Hypergeometric fallback when worker is unavailable
    var html = '<div class="prob-table-wrapper"><table class="prob-table">';
    html += '<thead><tr><th>Turn</th>';
    activeList.forEach(function(c) {
        html += '<th style="color:' + COLOR_HEX[c] + '">' + COLOR_NAMES[c] + ' (' + recommended[c] + ')</th>';
    });
    html += '</tr></thead><tbody>';

    for (var turn = 1; turn <= 7; turn++) {
        var cardsDrawn = 6 + turn;
        html += '<tr><td class="turn-col">Turn ' + turn + ' (' + cardsDrawn + ' cards)</td>';
        activeList.forEach(function(c) {
            var needed = 1; // need at least 1 source of this color by each turn
            var demand = findMostDemandingCard(c, state.cards);
            if (demand && turn >= demand.turn) needed = demand.pips;
            var prob = hypergeometricCDF_atLeast(needed, state.deckSize, recommended[c], cardsDrawn);
            var pctStr = (prob * 100).toFixed(1) + '%';
            var cls = prob >= 0.9 ? 'prob-good' : (prob >= 0.7 ? 'prob-ok' : 'prob-bad');
            html += '<td class="' + cls + '">' + pctStr + '</td>';
        });
        html += '</tr>';
    }
    html += '</tbody></table></div>';
    return html;
}

function basicLandName(c) {
    var names = { W: 'Plains', U: 'Island', B: 'Swamp', R: 'Mountain', G: 'Forest' };
    return names[c] || 'Basic Land';
}

function getColorPair(c1, c2) {
    // Return canonical pair ordering (WUBRG order)
    var order = 'WUBRG';
    if (order.indexOf(c1) < order.indexOf(c2)) return c1 + c2;
    return c2 + c1;
}

function buildDualSuggestions(activeList, recommended, colorlessLands) {
    var html = '';
    var pairs = [];
    var formatKey = state.format;
    var cycleKeys = FORMAT_CYCLE_KEYS[formatKey] || FORMAT_CYCLE_KEYS['custom'];

    // Generate all color pairs
    for (var i = 0; i < activeList.length; i++) {
        for (var j = i + 1; j < activeList.length; j++) {
            pairs.push(getColorPair(activeList[i], activeList[j]));
        }
    }

    // Find available lands per pair from format's cycles
    var availableLands = {}; // pair -> [{cycle, name, tier}]
    pairs.forEach(function(pair) { availableLands[pair] = []; });

    cycleKeys.forEach(function(key) {
        var cycle = LAND_CYCLES[key];
        if (!cycle) return;
        pairs.forEach(function(pair) {
            var cardName = cycle.cards[pair];
            if (cardName) {
                availableLands[pair].push({ cycle: cycle.name, name: cardName, tier: cycle.tier, desc: cycle.desc });
            }
        });
    });

    // Build suggestion: list all available dual lands per color pair
    html += '<div class="suggest-card">';
    html += '<h4>Available Dual Lands (' + formatKey.charAt(0).toUpperCase() + formatKey.slice(1) + ')</h4>';
    html += '<p>All dual land options for your color combination in this format, ordered by competitive tier.</p>';
    html += '</div>';

    pairs.forEach(function(pair) {
        var c1 = pair[0], c2 = pair[1];
        var lands = availableLands[pair];
        if (lands.length === 0) return;

        html += '<div class="suggest-card">';
        html += '<h4 style="display:flex;align-items:center;gap:0.5rem;">';
        html += '<span class="pip-color-dot" style="width:20px;height:20px;font-size:0.55rem;background:' + COLOR_HEX[c1] + ';color:' + COLOR_TEXT[c1] + (c1==='B'?';border:1px solid rgba(255,255,255,0.2)':'') + '">' + c1 + '</span>';
        html += '<span class="pip-color-dot" style="width:20px;height:20px;font-size:0.55rem;background:' + COLOR_HEX[c2] + ';color:' + COLOR_TEXT[c2] + (c2==='B'?';border:1px solid rgba(255,255,255,0.2)':'') + '">' + c2 + '</span>';
        html += ' ' + COLOR_NAMES[c1] + ' / ' + COLOR_NAMES[c2] + ' (' + lands.length + ' options)';
        html += '</h4>';
        html += '<div class="suggest-lands" style="flex-direction:column;gap:0.3rem;">';

        lands.forEach(function(land) {
            var tierLabel = land.tier === 1 ? 'Premium' : (land.tier === 2 ? 'Good' : 'Budget');
            var tierColor = land.tier === 1 ? '#4ade80' : (land.tier === 2 ? '#facc15' : '#71717a');
            html += '<span class="suggest-land" style="justify-content:space-between;width:100%;">';
            html += '<span><strong>' + land.name + '</strong> <span style="color:var(--text-muted);font-size:0.65rem;">(' + land.cycle + ')</span></span>';
            html += '<span style="color:' + tierColor + ';font-size:0.65rem;font-weight:600;">' + tierLabel + '</span>';
            html += '</span>';
        });
        html += '</div></div>';
    });

    // Suggested allocation — greedily fill duals by tier, then basics
    var copiesPerCycle = (formatKey === 'commander') ? 1 : 4;
    if (formatKey === 'limited') copiesPerCycle = 1;

    // Minimum basics: at least 1 per color for fetch targets / consistency
    var minBasicsPerColor = (formatKey === 'commander') ? 2 : 1;
    var minBasics = minBasicsPerColor * activeList.length;
    var maxDuals = Math.max(0, state.totalLands - colorlessLands - minBasics);

    // Collect all available duals sorted by tier (premium first)
    var allDuals = [];
    pairs.forEach(function(pair) {
        availableLands[pair].forEach(function(land) {
            allDuals.push({ pair: pair, cycle: land.cycle, name: land.name, tier: land.tier });
        });
    });
    allDuals.sort(function(a, b) { return a.tier - b.tier; });

    // Greedily allocate playsets until we hit maxDuals
    var suggestedDuals = [];
    var totalDualCount = 0;
    allDuals.forEach(function(d) {
        if (totalDualCount >= maxDuals) return;
        var qty = Math.min(copiesPerCycle, maxDuals - totalDualCount);
        suggestedDuals.push({ name: d.name, cycle: d.cycle, tier: d.tier, qty: qty, pair: d.pair });
        totalDualCount += qty;
    });

    // Track how many sources each color gets from duals
    var sourcesFromDuals = {};
    activeList.forEach(function(c) { sourcesFromDuals[c] = 0; });
    suggestedDuals.forEach(function(d) {
        sourcesFromDuals[d.pair[0]] += d.qty;
        sourcesFromDuals[d.pair[1]] += d.qty;
    });

    // Remaining slots = basics, split proportionally by pip count
    var basicTotal = state.totalLands - totalDualCount - colorlessLands;
    var basicsPerColor = {};
    var totalPipCount = 0;
    activeList.forEach(function(c) { totalPipCount += state.pips[c]; });
    activeList.forEach(function(c) {
        if (totalPipCount > 0) {
            basicsPerColor[c] = Math.max(minBasicsPerColor, Math.round(basicTotal * state.pips[c] / totalPipCount));
        } else {
            basicsPerColor[c] = Math.max(minBasicsPerColor, Math.round(basicTotal / activeList.length));
        }
    });
    // Fix rounding to match basicTotal exactly
    var assignedBasics = 0;
    activeList.forEach(function(c) { assignedBasics += basicsPerColor[c]; });
    var bDiff = basicTotal - assignedBasics;
    if (bDiff !== 0) {
        var sortedByPips = activeList.slice().sort(function(a, b) { return state.pips[b] - state.pips[a]; });
        var idx = 0;
        while (bDiff > 0 && idx < sortedByPips.length) { basicsPerColor[sortedByPips[idx]]++; bDiff--; idx++; }
        while (bDiff < 0 && idx < sortedByPips.length) {
            if (basicsPerColor[sortedByPips[idx]] > 0) { basicsPerColor[sortedByPips[idx]]--; bDiff++; }
            idx++;
        }
    }

    // Suggested split
    html += '<div class="suggest-card">';
    html += '<h4>Suggested Split (' + totalDualCount + ' duals, ' + basicTotal + ' basics)</h4>';
    html += '<p>Fill with premium duals first for best mana consistency. Adjust based on your curve and aggression level.</p>';
    html += '<div class="suggest-lands" style="flex-direction:column;gap:0.3rem;">';
    suggestedDuals.forEach(function(d) {
        var tierLabel = d.tier === 1 ? 'Premium' : (d.tier === 2 ? 'Good' : 'Budget');
        var tierColor = d.tier === 1 ? '#4ade80' : (d.tier === 2 ? '#facc15' : '#71717a');
        html += '<span class="suggest-land" style="justify-content:space-between;width:100%;">';
        html += '<span><span class="sl-count">' + d.qty + '</span> ' + d.name + ' <span style="color:var(--text-muted);font-size:0.65rem;">(' + d.cycle + ')</span></span>';
        html += '<span style="color:' + tierColor + ';font-size:0.65rem;font-weight:600;">' + tierLabel + '</span>';
        html += '</span>';
    });
    activeList.forEach(function(c) {
        if (basicsPerColor[c] > 0) {
            html += '<span class="suggest-land"><span class="sl-count">' + basicsPerColor[c] + '</span> ' + basicLandName(c) + '</span>';
        }
    });
    if (colorlessLands > 0) {
        html += '<span class="suggest-land"><span class="sl-count">' + colorlessLands + '</span> Utility / Colorless</span>';
    }
    html += '</div></div>';

    // Triomes for 3+ color decks
    if (activeList.length >= 3 && (formatKey === 'pioneer' || formatKey === 'modern' || formatKey === 'legacy' || formatKey === 'commander')) {
        html += '<div class="suggest-card">';
        html += '<h4>Consider Triomes</h4>';
        html += '<p>With ' + activeList.length + ' colors, Triomes (3-color lands from Ikoria/Streets of New Capenna) provide excellent fixing. They are fetchable and provide three colors, at the cost of always entering tapped.</p>';
        html += '</div>';
    }

    // Commander special
    if (formatKey === 'commander' && activeList.length >= 2) {
        html += '<div class="suggest-card">';
        html += '<h4>Commander Staples</h4>';
        html += '<p>Don\'t forget Commander-specific lands that provide all your colors:</p>';
        html += '<div class="suggest-lands">';
        html += '<span class="suggest-land"><span class="sl-count">1</span> Command Tower</span>';
        html += '<span class="suggest-land"><span class="sl-count">1</span> Exotic Orchard</span>';
        html += '<span class="suggest-land"><span class="sl-count">1</span> Path of Ancestry</span>';
        if (activeList.length >= 3) {
            html += '<span class="suggest-land"><span class="sl-count">1</span> Chromatic Lantern (mana rock)</span>';
        }
        html += '</div></div>';
    }

    return html;
}

function showEmptyResults(msg) {
    document.getElementById('resultsContent').innerHTML = '<div class="results-empty"><div class="empty-icon">&#127183;</div><p>' + msg + '</p></div>';
}

// ══════════════════════════════════════════
// Decklist Import
// ══════════════════════════════════════════

function switchTab(tab) {
    var tabs = document.querySelectorAll('.input-tab');
    tabs.forEach(function(t) {
        t.classList.toggle('active', t.dataset.tab === tab);
    });
    document.getElementById('manualPanel').classList.toggle('active', tab === 'manual');
    document.getElementById('importPanel').classList.toggle('active', tab === 'import');
}

function setImportStatus(msg, type) {
    var el = document.getElementById('importStatus');
    el.className = 'import-status visible ' + type;
    el.innerHTML = msg;
}

function hideImportStatus() {
    var el = document.getElementById('importStatus');
    el.className = 'import-status';
    el.innerHTML = '';
}

function parseDecklist(text) {
    var lines = text.split('\n');
    var cards = [];
    var lineRe = /^\s*(\d+)x?\s+(.+?)(?:\s+\([A-Z0-9]+\)\s*\d+.*)?$/;
    var sideboardRe = /^\s*(Sideboard|SB:|Companion|Maybeboard)/i;
    var skipRe = /^\s*(\/\/|Commander|Deck)/i;
    var startedParsing = false;
    for (var i = 0; i < lines.length; i++) {
        var line = lines[i].trim();
        // Sideboard header = stop parsing
        if (sideboardRe.test(line)) break;
        // Blank line after we've started = sideboard separator (MTGA format)
        if (!line) {
            if (startedParsing) break;
            continue;
        }
        // Skip comment and section header lines
        if (skipRe.test(line)) continue;
        var m = line.match(lineRe);
        if (m) {
            startedParsing = true;
            var qty = parseInt(m[1]);
            var name = m[2].trim();
            // Handle split/MDFC — use front face
            var slashIdx = name.indexOf(' // ');
            if (slashIdx > 0) name = name.substring(0, slashIdx);
            cards.push({ qty: qty, name: name });
        }
    }
    // Deduplicate by name
    var deduped = {};
    cards.forEach(function(c) {
        var key = c.name.toLowerCase();
        if (deduped[key]) {
            deduped[key].qty += c.qty;
        } else {
            deduped[key] = { qty: c.qty, name: c.name };
        }
    });
    return Object.values(deduped);
}

function parseManaCost(costStr) {
    // Parse Scryfall mana_cost string like "{1}{W}{U}" or "{2}{R}{R}"
    var pips = { W: 0, U: 0, B: 0, R: 0, G: 0 };
    var mv = 0;
    if (!costStr) return { pips: pips, mv: mv };
    var symbolRe = /\{([^}]+)\}/g;
    var match;
    while ((match = symbolRe.exec(costStr)) !== null) {
        var sym = match[1];
        if (sym === 'X') {
            // X costs = 0 for MV
            continue;
        } else if (/^\d+$/.test(sym)) {
            // Generic mana
            mv += parseInt(sym);
        } else if (/^[WUBRG]$/.test(sym)) {
            // Single colored pip
            pips[sym]++;
            mv++;
        } else if (/^[WUBRG]\/P$/.test(sym)) {
            // Phyrexian pip — count as the color
            pips[sym[0]]++;
            mv++;
        } else if (/^[WUBRG]\/[WUBRG]$/.test(sym)) {
            // Hybrid pip — need a source of either color, count 1 for each
            pips[sym[0]]++;
            pips[sym[2]]++;
            mv++;
        } else if (/^2\/[WUBRG]$/.test(sym)) {
            // Twobrid — count as the color
            pips[sym[2]]++;
            mv += 2;
        } else {
            // Snow, colorless pips, etc. — just add to MV
            mv++;
        }
    }
    return { pips: pips, mv: mv };
}

async function lookupCards(cards) {
    // Split into batches of 75
    var batches = [];
    for (var i = 0; i < cards.length; i += 75) {
        batches.push(cards.slice(i, i + 75));
    }
    var allFound = [];
    var notFound = [];
    for (var b = 0; b < batches.length; b++) {
        if (b > 0) {
            // Respect Scryfall rate limit
            await new Promise(function(r) { setTimeout(r, 100); });
        }
        var identifiers = batches[b].map(function(c) { return { name: c.name }; });
        var resp = await fetch('https://api.scryfall.com/cards/collection', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ identifiers: identifiers })
        });
        if (!resp.ok) {
            throw new Error('Scryfall API returned ' + resp.status);
        }
        var data = await resp.json();
        if (data.data) allFound = allFound.concat(data.data);
        if (data.not_found) notFound = notFound.concat(data.not_found);
    }
    return { found: allFound, notFound: notFound };
}

function autoDetectFormat(deckSize) {
    if (deckSize === 40) return 'limited';
    if (deckSize >= 98 && deckSize <= 101) return 'commander';
    return null; // user selects for 60-card
}

function updateUIFromState() {
    // Update deck size and total lands inputs
    document.getElementById('deckSize').value = state.deckSize;
    document.getElementById('totalLands').value = state.totalLands;

    // Update format buttons
    var detectedFormat = autoDetectFormat(state.deckSize);
    if (detectedFormat) {
        state.format = detectedFormat;
        var btns = document.querySelectorAll('.format-btn');
        btns.forEach(function(b) {
            b.classList.toggle('active', b.dataset.format === detectedFormat);
        });
    }

    // Update color toggles
    var toggles = document.querySelectorAll('.color-toggle');
    toggles.forEach(function(t) {
        var c = t.dataset.color;
        t.classList.toggle('active', state.activeColors.has(c));
    });

    // Rebuild pip inputs
    renderPipInputs();

    // Update curve inputs
    var curveInputs = document.querySelectorAll('#curveInputs input');
    curveInputs.forEach(function(inp) {
        var mv = parseInt(inp.dataset.mv);
        inp.value = state.curve[mv] || 0;
    });

    updateCurveTotal();
}

async function importDecklist() {
    var textarea = document.getElementById('decklistInput');
    var text = textarea.value.trim();

    if (!text) {
        setImportStatus('Paste a decklist to import.', 'error');
        return;
    }

    hideImportStatus();

    // Step 1: Parse
    var cards = parseDecklist(text);
    if (cards.length === 0) {
        setImportStatus('No valid card lines found. Use format: <strong>4 Card Name</strong>', 'error');
        return;
    }

    var totalCards = cards.reduce(function(s, c) { return s + c.qty; }, 0);
    setImportStatus('<span class="import-spinner"></span> Parsed ' + cards.length + ' unique cards (' + totalCards + ' total). Looking up card data...', 'loading');

    // Step 2: Scryfall lookup
    var result;
    try {
        result = await lookupCards(cards);
    } catch (e) {
        setImportStatus('Could not reach Scryfall API. Check your connection.', 'error');
        return;
    }

    // Build a lookup map: lowercase name -> scryfall card object
    var cardMap = {};
    result.found.forEach(function(card) {
        cardMap[card.name.toLowerCase()] = card;
    });

    // Step 3: Process results — build per-card data AND aggregate state
    var totalPips = { W: 0, U: 0, B: 0, R: 0, G: 0 };
    var curve = [0, 0, 0, 0, 0, 0, 0, 0]; // MV 0-7+
    var totalLands = 0;
    var totalSpells = 0;
    var colorsFound = new Set();
    var perCardData = []; // [{name, qty, mv, pips, isLand, producesColors}]

    cards.forEach(function(c) {
        var scryfallCard = cardMap[c.name.toLowerCase()];
        if (!scryfallCard) return;

        var typeLine = scryfallCard.type_line || '';
        if (/\bLand\b/i.test(typeLine)) {
            totalLands += c.qty;
            // Extract produced colors from Scryfall data
            var producesColors = [];
            if (scryfallCard.produced_mana) {
                producesColors = scryfallCard.produced_mana.filter(function(m) { return 'WUBRG'.indexOf(m) >= 0; });
            }
            perCardData.push({ name: scryfallCard.name, qty: c.qty, mv: 0, pips: { W:0, U:0, B:0, R:0, G:0 }, isLand: true, producesColors: producesColors });
            return;
        }

        // Get mana costs — handle adventures, split cards, and MDFCs
        var layout = scryfallCard.layout || '';
        var faces = scryfallCard.card_faces || [];

        // For multi-face cards, always use individual faces to avoid double-counting
        // Top-level mana_cost on adventures/splits concatenates both faces
        var allPips = { W: 0, U: 0, B: 0, R: 0, G: 0 };
        var mainMV = 0;

        if ((layout === 'adventure' || layout === 'split') && faces.length > 1) {
            // Count pips from all faces, use front face MV for curve
            faces.forEach(function(face, idx) {
                var parsed = parseManaCost(face.mana_cost || '');
                COLORS.forEach(function(col) { allPips[col] += parsed.pips[col]; });
                if (idx === 0) mainMV = parsed.mv;
            });
        } else {
            // Normal cards, MDFCs, transforms — use front face only
            var mainCost = scryfallCard.mana_cost || '';
            if (!mainCost && faces.length > 0) {
                mainCost = faces[0].mana_cost || '';
            }
            var mainParsed = parseManaCost(mainCost);
            allPips = mainParsed.pips;
            mainMV = mainParsed.mv;
        }

        // Build per-card data
        perCardData.push({ name: scryfallCard.name, qty: c.qty, mv: mainMV, pips: Object.assign({}, allPips), isLand: false, producesColors: null });

        // Accumulate pips * quantity
        COLORS.forEach(function(col) {
            var pipCount = allPips[col] * c.qty;
            totalPips[col] += pipCount;
            if (allPips[col] > 0) colorsFound.add(col);
        });

        // Mana curve — use front face MV, cap at 7
        var mvSlot = Math.min(mainMV, 7);
        curve[mvSlot] += c.qty;
        totalSpells += c.qty;
    });

    // Check edge cases
    if (totalSpells === 0 && totalLands > 0) {
        setImportStatus('Decklist contains only lands. Add some spells!', 'error');
        return;
    }
    if (totalSpells === 0 && totalLands === 0) {
        var nfNames = result.notFound.map(function(nf) { return nf.name || JSON.stringify(nf); });
        setImportStatus('No cards recognized by Scryfall.' + (nfNames.length > 0 ? ' Not found: ' + nfNames.join(', ') : ''), 'error');
        return;
    }

    // Step 4: Populate state
    state.activeColors = colorsFound;
    state.pips = totalPips;
    state.curve = curve;
    state.deckSize = totalSpells + totalLands;
    state.totalLands = totalLands;
    state.mode = 'imported';
    state.cards = perCardData;
    state.simResults = null;

    // Step 5: Update UI
    updateUIFromState();

    // Step 6: Switch to manual tab so user can review
    switchTab('manual');

    // Step 7: Auto-calculate
    calculate(true);

    // Step 8: Show success status (on the import panel for when they switch back)
    var statusMsg = 'Imported ' + totalSpells + ' spells, ' + totalLands + ' lands (' + state.deckSize + ' cards).';
    if (colorsFound.size > 0) {
        statusMsg += ' Colors: ' + Array.from(colorsFound).join('');
    }
    if (result.notFound.length > 0) {
        statusMsg += '<br>Not found (' + result.notFound.length + '): ';
        var nfList = '<ul class="import-notfound">';
        result.notFound.forEach(function(nf) {
            nfList += '<li>' + (nf.name || JSON.stringify(nf)) + '</li>';
        });
        nfList += '</ul>';
        statusMsg += nfList;
        setImportStatus(statusMsg, 'info');
    } else {
        setImportStatus(statusMsg, 'success');
    }
}

// ══════════════════════════════════════════
// Init
// ══════════════════════════════════════════
init();
</script>
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebApplication","name":"MTG Mana Calculator","url":"https://scrollvault.net/tools/manabase/","applicationCategory":"UtilitiesApplication","description":"Free MTG mana calculator and manabase tool using Frank Karsten's mana math. Get optimal land counts for Standard, Modern, Pioneer, and Commander with hypergeometric probability.","isPartOf":{"@type":"WebSite","name":"ScrollVault","url":"https://scrollvault.net"}}
</script>
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"FAQPage","mainEntity":[{"@type":"Question","name":"How many lands should I put in my MTG deck?","acceptedAnswer":{"@type":"Answer","text":"For a 60-card deck (Standard, Modern, Pioneer), 23-26 lands is typical depending on your mana curve. Aggro decks run 22-23, midrange runs 24-25, and control runs 25-26. For Commander (99 cards + commander), 35-38 lands is the standard range. Use a manabase calculator based on Frank Karsten's math for precise counts tailored to your specific deck."}},{"@type":"Question","name":"How many lands for a 60-card deck?","acceptedAnswer":{"@type":"Answer","text":"Most competitive 60-card decks play between 22 and 26 lands. The exact number depends on your average mana value (mana curve). Low-curve aggro decks like Mono-Red or Burn can get away with 20-22 lands, especially if they run cheap cantrips. Midrange decks typically want 24 lands, while control and ramp strategies often play 25-27. Enter your mana curve into the calculator for a personalized recommendation."}},{"@type":"Question","name":"How many lands for Commander / EDH?","acceptedAnswer":{"@type":"Answer","text":"Commander decks (99 cards + commander) typically run 35-38 lands. The ratio is slightly different from 60-card formats because of the larger deck size and singleton restriction. Decks with a low mana curve and lots of mana rocks can go as low as 33, while 4+ color decks or landfall strategies may want 38-40. Don't forget to count mana-producing artifacts like Sol Ring and signets when planning your mana base."}},{"@type":"Question","name":"What is Frank Karsten's mana math?","acceptedAnswer":{"@type":"Answer","text":"Frank Karsten's mana math is the gold standard for calculating MTG mana bases. Using hypergeometric probability, Karsten determined exactly how many colored sources you need to cast your spells on curve with approximately 90% consistency. For example, a card costing 1WW in a 60-card deck needs about 18 white sources. His research, published on ChannelFireball, is the foundation used by competitive players and this calculator."}},{"@type":"Question","name":"How many colored sources do I need?","acceptedAnswer":{"@type":"Answer","text":"The number of colored sources depends on how many pips of that color appear in your casting costs and what turn you need them. Karsten's guidelines for a 60-card deck: a single colored pip on turn 1 needs about 14 sources, a single pip on turn 3 needs about 12, and double pips (like 1WW) need about 18 sources. This calculator does the math automatically — just input your colored mana symbols and it computes the sources needed per color."}},{"@type":"Question","name":"What is the 40% rule for lands?","acceptedAnswer":{"@type":"Answer","text":"The 40% rule is a rough guideline that suggests about 40% of your deck should be lands. For a 60-card deck that's 24 lands, and for a 40-card Limited deck that's 16-17 lands. While this rule of thumb works as a starting point, the actual number should depend on your mana curve. Aggressive decks with lots of 1-2 drops can go below 40%, while control decks may want to stay at or above it."}},{"@type":"Question","name":"How do dual lands affect my mana base?","acceptedAnswer":{"@type":"Answer","text":"Dual lands (lands that produce two or more colors) are crucial for multicolor decks because each one counts as a source for every color it produces. A Hallowed Fountain counts as both a white source and a blue source, reducing the total lands you need. Premium duals like shock lands and fetch lands are the most efficient because they enter untapped or have basic land types. This calculator's land suggestions section recommends specific dual land cycles based on your format and colors."}},{"@type":"Question","name":"How many lands for a 3-color Commander deck?","acceptedAnswer":{"@type":"Answer","text":"A three-color Commander deck typically runs 36-38 lands, but the real challenge is the color distribution. Each color needs at least 14-16 sources to reliably cast single-pip spells by turn 3. With three colors, you need heavy investment in multicolor lands: fetch lands, shock lands, triomes, and check lands that produce two of your three colors. Budget options include pain lands, filter lands, and the battlebond lands."}},{"@type":"Question","name":"What is the mana curve and why does it matter for lands?","acceptedAnswer":{"@type":"Answer","text":"The mana curve is the distribution of mana values (casting costs) across your nonland cards. It directly determines how many lands you need: a deck full of 1-2 drops can function on 22 lands, while a deck with lots of 4-6 drops needs 25+. The ideal curve depends on your strategy — aggro decks want a low curve peaking at 1-2, midrange peaks at 2-3, and control wants a flatter distribution with powerful top-end."}},{"@type":"Question","name":"How do I calculate mana for Limited / Draft decks?","acceptedAnswer":{"@type":"Answer","text":"For 40-card Limited decks (Draft and Sealed), the standard is 17 lands. The color split depends on your deck's pip distribution. A mostly-red deck splashing white might run 10 Mountains and 7 Plains, while an even two-color deck wants about 9/8 or 8/9. Use the Limited format preset in this calculator, enter your colored pips from your drafted cards, and it computes the optimal basic land split."}},{"@type":"Question","name":"How does this mana calculator differ from other MTG land calculators?","acceptedAnswer":{"@type":"Answer","text":"Most MTG land calculators only tell you how many total lands to run. This calculator goes further by implementing Frank Karsten's hypergeometric probability model — the same math used by Pro Tour players. It calculates the exact number of colored sources per color, shows your probability of casting each spell on curve, and recommends specific dual land cycles for your format. It also includes a decklist import feature that auto-detects your mana pips via Scryfall."}},{"@type":"Question","name":"Should I count mana rocks as colored sources?","acceptedAnswer":{"@type":"Answer","text":"Mana rocks like Sol Ring, Arcane Signet, and Signets contribute to your mana production but are not technically lands. In Commander, mana rocks are essential — most decks run 8-12 ramp pieces. A rock that produces your color counts as roughly 0.5-0.75 of a colored source because it can be removed and doesn't affect your opening hand land count. The safe approach: build your land base as if rocks don't exist, then add rocks on top as acceleration."}}]}
</script>
</body>
</html>
