<!-- HAND-CRAFTED - DO NOT MODIFY VIA AGENTS -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sealed Pool Simulator | ScrollVault</title>
    <meta name="description" content="Open 6 virtual booster packs from any MTG set and build a sealed deck. Sort by color, type, CMC, or rarity.">
    <meta property="og:site_name" content="ScrollVault">
    <meta property="og:title" content="Sealed Pool Simulator | ScrollVault">
    <meta property="og:description" content="Simulate opening 6 MTG booster packs. Sort your pool and build a sealed deck.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://scrollvault.net/tools/sealed/">
    <link rel="canonical" href="https://scrollvault.net/tools/sealed/">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" href="/favicon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="/apple-touch-icon.png">
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-1CV3DS33WK"></script>
    <script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js',new Date());gtag('config','G-1CV3DS33WK');</script>
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebApplication",
        "name": "Sealed Pool Simulator",
        "description": "Open 6 virtual booster packs from any MTG set and build a sealed deck",
        "url": "https://scrollvault.net/tools/sealed/",
        "applicationCategory": "GameApplication",
        "publisher": { "@type": "Organization", "name": "ScrollVault", "url": "https://scrollvault.net" }
    }
    </script>
<style>
/* ── Theme Variables ── */
:root {
    --bg-dark: #0f0f0f;
    --card-bg: #1a1a1a;
    --card-border: rgba(255,255,255,0.08);
    --card-hover-glow: rgba(139,92,246,0.25);
    --text-primary: #ffffff;
    --text-secondary: #a1a1aa;
    --text-muted: #71717a;
    --nav-bg: rgba(15,15,15,0.95);
    --nav-border: rgba(255,255,255,0.06);
    --gradient-purple: linear-gradient(135deg, #a855f7 0%, #6366f1 100%);
    --shadow-sm: 0 1px 2px rgba(0,0,0,0.3);
    --shadow-md: 0 4px 6px rgba(0,0,0,0.4);
    --shadow-lg: 0 10px 15px rgba(0,0,0,0.5);
    --color-W: #F9FAF4;
    --color-U: #0E68AB;
    --color-B: #150B00;
    --color-R: #D3202A;
    --color-G: #00733E;
}

* { margin: 0; padding: 0; box-sizing: border-box; }
html { scroll-behavior: smooth; }
body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg-dark); color: var(--text-primary); line-height: 1.6; min-height: 100vh; }
h1,h2,h3,h4,h5,h6 { font-family: 'Space Grotesk', -apple-system, sans-serif; font-weight: 600; line-height: 1.3; }
a { color: inherit; text-decoration: none; transition: color 0.2s ease; }
a:hover { color: #a78bfa; }
.container { max-width: 1280px; margin: 0 auto; padding: 0 1rem; }

/* ── Nav ── */
.nav { position: fixed; top: 0; left: 0; right: 0; background: var(--nav-bg); backdrop-filter: blur(10px); border-bottom: 1px solid var(--nav-border); z-index: 1000; height: 64px; display: flex; align-items: center; }
.nav-content { display: flex; justify-content: space-between; align-items: center; width: 100%; }
.nav-logo { font-family: 'Space Grotesk', sans-serif; font-size: 1.5rem; font-weight: 700; background: var(--gradient-purple); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
.nav-links { display: flex; gap: 2rem; list-style: none; }
.nav-links a { font-size: 0.9rem; font-weight: 500; color: var(--text-secondary); }
.nav-links a:hover, .nav-links a.active { color: var(--text-primary); }
.mobile-menu-btn { display: none; background: none; border: none; color: var(--text-primary); font-size: 1.5rem; cursor: pointer; }
@media (max-width: 768px) {
    .nav-links { display: none; position: absolute; top: 64px; left: 0; right: 0; background: var(--nav-bg); border-bottom: 1px solid var(--nav-border); flex-direction: column; padding: 1rem; gap: 0; }
    .nav-links.active { display: flex; }
    .nav-links a { padding: 0.75rem 1rem; display: block; border-bottom: 1px solid var(--card-border); }
    .nav-links a:last-child { border-bottom: none; }
    .mobile-menu-btn { display: block; }
}

/* ── Footer ── */
footer { border-top: 1px solid var(--card-border); padding: 2rem 0; text-align: center; }
.footer-content { display: flex; flex-direction: column; align-items: center; gap: 1rem; }
.footer-logo { font-family: 'Space Grotesk', sans-serif; font-size: 1.25rem; font-weight: 700; background: var(--gradient-purple); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
.wubrg-dots { display: flex; gap: 0.5rem; }
.mana-dot { width: 12px; height: 12px; border-radius: 50%; }
.footer-text { color: var(--text-muted); font-size: 0.8rem; max-width: 500px; }
.footer-links { list-style: none; display: flex; gap: 1.5rem; flex-wrap: wrap; justify-content: center; }
.footer-links a { color: var(--text-muted); font-size: 0.8rem; }
.footer-links a:hover { color: #a78bfa; }

/* ── Main Layout ── */
main { margin-top: 64px; min-height: calc(100vh - 64px); padding: 2rem 0 3rem; }

/* ── Breadcrumb ── */
.breadcrumb { font-size: 0.85rem; color: var(--text-muted); margin-bottom: 1.5rem; }
.breadcrumb a { color: var(--text-secondary); }
.breadcrumb a:hover { color: #a78bfa; }
.breadcrumb span { margin: 0 0.4rem; }

/* ── Page Header ── */
.page-header { margin-bottom: 2rem; }
.page-header h1 { font-size: 2rem; margin-bottom: 0.5rem; background: var(--gradient-purple); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
.page-header p { color: var(--text-secondary); font-size: 1rem; max-width: 600px; }

/* ── Set Selection ── */
.set-selection { background: var(--card-bg); border: 1px solid var(--card-border); border-radius: 12px; padding: 2rem; margin-bottom: 2rem; }
.set-selection h2 { font-size: 1.25rem; margin-bottom: 1rem; }
.set-picker { display: flex; gap: 1rem; align-items: center; flex-wrap: wrap; }
.set-picker select { flex: 1; min-width: 200px; background: var(--bg-dark); border: 1px solid var(--card-border); color: var(--text-primary); padding: 0.75rem 1rem; border-radius: 8px; font-size: 0.95rem; font-family: 'Inter', sans-serif; cursor: pointer; appearance: none; -webkit-appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23a1a1aa' d='M6 8L1 3h10z'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 12px center; padding-right: 2.5rem; }
.set-picker select:focus { outline: none; border-color: #a855f7; box-shadow: 0 0 0 2px rgba(168,85,247,0.2); }
.set-icon { width: 32px; height: 32px; filter: invert(1) brightness(0.8); flex-shrink: 0; }
.btn-primary { background: var(--gradient-purple); color: #fff; border: none; padding: 0.75rem 2rem; border-radius: 8px; font-size: 0.95rem; font-weight: 600; font-family: 'Space Grotesk', sans-serif; cursor: pointer; transition: transform 0.15s, box-shadow 0.15s; white-space: nowrap; }
.btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 15px rgba(168,85,247,0.4); }
.btn-primary:active { transform: translateY(0); }
.btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }
.btn-secondary { background: transparent; color: var(--text-secondary); border: 1px solid var(--card-border); padding: 0.5rem 1.25rem; border-radius: 8px; font-size: 0.85rem; font-weight: 500; font-family: 'Inter', sans-serif; cursor: pointer; transition: all 0.15s; }
.btn-secondary:hover { border-color: #a855f7; color: var(--text-primary); }
.btn-secondary.active { background: rgba(168,85,247,0.15); border-color: #a855f7; color: #a78bfa; }

/* ── Loading ── */
.loading-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(4px); z-index: 2000; justify-content: center; align-items: center; flex-direction: column; gap: 1.5rem; }
.loading-overlay.visible { display: flex; }
.spinner { width: 48px; height: 48px; border: 3px solid var(--card-border); border-top-color: #a855f7; border-radius: 50%; animation: spin 0.8s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }
.loading-text { color: var(--text-secondary); font-size: 0.95rem; }
.loading-progress { color: var(--text-muted); font-size: 0.8rem; }

/* ── Pool View ── */
.pool-section { display: none; }
.pool-section.visible { display: block; }
.pool-controls { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; margin-bottom: 1.5rem; }
.pool-controls h2 { font-size: 1.25rem; }
.sort-buttons { display: flex; gap: 0.5rem; flex-wrap: wrap; }
.pool-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 0.75rem; margin-bottom: 2rem; }

/* ── Card ── */
.card-slot { position: relative; border-radius: 10px; overflow: hidden; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; aspect-ratio: 488/680; background: var(--card-bg); }
.card-slot img { width: 100%; height: 100%; object-fit: cover; display: block; border-radius: 10px; transition: opacity 0.15s; }
.card-slot:hover { transform: translateY(-4px) scale(1.02); box-shadow: 0 8px 25px rgba(168,85,247,0.3); z-index: 10; }
.card-slot.in-deck { box-shadow: 0 0 0 3px #a855f7, 0 4px 15px rgba(168,85,247,0.4); }
.card-slot.in-deck::after { content: '\2713'; position: absolute; top: 6px; right: 8px; background: #a855f7; color: #fff; width: 22px; height: 22px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: 700; }
.card-slot.dimmed { opacity: 0.35; }
.card-slot.dimmed:hover { opacity: 0.7; }
.card-placeholder { width: 100%; height: 100%; background: var(--card-bg); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: var(--text-muted); font-size: 0.75rem; text-align: center; padding: 0.5rem; }

/* ── Deck Builder ── */
.builder-section { display: none; background: var(--card-bg); border: 1px solid var(--card-border); border-radius: 12px; padding: 1.5rem; margin-top: 2rem; }
.builder-section.visible { display: block; }
.builder-header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; margin-bottom: 1.5rem; }
.builder-header h2 { font-size: 1.25rem; }
.deck-counter { font-size: 1rem; font-weight: 600; color: var(--text-secondary); }
.deck-counter .count { color: #a78bfa; font-size: 1.15rem; }
.deck-counter.complete .count { color: #34d399; }

/* ── Basic Lands ── */
.lands-helper { background: var(--bg-dark); border: 1px solid var(--card-border); border-radius: 10px; padding: 1rem 1.25rem; margin-bottom: 1.5rem; }
.lands-helper h3 { font-size: 0.95rem; margin-bottom: 0.75rem; color: var(--text-secondary); }
.lands-row { display: flex; gap: 1rem; flex-wrap: wrap; }
.land-control { display: flex; align-items: center; gap: 0.5rem; }
.land-label { font-size: 0.85rem; color: var(--text-secondary); min-width: 56px; display: flex; align-items: center; gap: 0.35rem; }
.land-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
.land-btn { width: 28px; height: 28px; border-radius: 6px; border: 1px solid var(--card-border); background: var(--card-bg); color: var(--text-primary); font-size: 1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.15s; }
.land-btn:hover { border-color: #a855f7; background: rgba(168,85,247,0.15); }
.land-count { font-size: 0.9rem; font-weight: 600; min-width: 18px; text-align: center; color: var(--text-primary); }

/* ── CMC Curve ── */
.curve-chart { background: var(--bg-dark); border: 1px solid var(--card-border); border-radius: 10px; padding: 1rem 1.25rem; margin-bottom: 1.5rem; }
.curve-chart h3 { font-size: 0.95rem; margin-bottom: 0.75rem; color: var(--text-secondary); }
.curve-bars { display: flex; align-items: flex-end; gap: 4px; height: 80px; }
.curve-bar-wrapper { flex: 1; display: flex; flex-direction: column; align-items: center; height: 100%; justify-content: flex-end; }
.curve-bar { width: 100%; min-height: 2px; background: var(--gradient-purple); border-radius: 3px 3px 0 0; transition: height 0.3s ease; }
.curve-label { font-size: 0.65rem; color: var(--text-muted); margin-top: 4px; }
.curve-count { font-size: 0.65rem; color: var(--text-secondary); margin-bottom: 2px; }

/* ── Deck Grid ── */
.deck-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 0.6rem; }
.deck-grid .card-slot { }
.deck-grid .card-slot.in-deck { box-shadow: none; }
.deck-grid .card-slot.in-deck::after { display: none; }

/* ── Action Bar ── */
.action-bar { display: flex; gap: 0.75rem; flex-wrap: wrap; margin-bottom: 1.5rem; }

/* ── Responsive ── */
@media (max-width: 768px) {
    .page-header h1 { font-size: 1.5rem; }
    .set-selection { padding: 1.25rem; }
    .set-picker { flex-direction: column; align-items: stretch; }
    .set-picker select { min-width: unset; }
    .pool-grid { grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 0.5rem; }
    .deck-grid { grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); }
    .pool-controls { flex-direction: column; align-items: flex-start; }
    .lands-row { gap: 0.5rem; }
    .land-control { flex: 1 1 45%; min-width: 140px; }
    .builder-section { padding: 1rem; }
}
@media (max-width: 480px) {
    .pool-grid { grid-template-columns: repeat(3, 1fr); }
    .deck-grid { grid-template-columns: repeat(3, 1fr); }
}
</style>
</head>
<body>
<nav class="nav">
    <div class="container nav-content">
        <a href="/" class="nav-logo">ScrollVault</a>
        <button class="mobile-menu-btn" onclick="document.getElementById('navLinks').classList.toggle('active')">&#9776;</button>
        <ul class="nav-links" id="navLinks">
            <li><a href="/">Home</a></li>
            <li><a href="/news/">News</a></li>
            <li><a href="/guides/">Guides</a></li>
            <li><a href="/decks/">Top Decks</a></li>
            <li><a href="/draft/">Draft</a></li>
            <li><a href="/tools/" class="active">Tools</a></li>
            <li><a href="/about.html">About</a></li>
            <li><a href="/contact.html">Contact</a></li>
        </ul>
    </div>
</nav>

<div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
    <div class="loading-text" id="loadingText">Fetching cards from Scryfall...</div>
    <div class="loading-progress" id="loadingProgress"></div>
</div>

<main>
    <div class="container">
        <div class="breadcrumb">
            <a href="/">Home</a><span>/</span>
            <a href="/tools/">Tools</a><span>/</span>
            Sealed Pool Simulator
        </div>

        <div class="page-header">
            <h1>Sealed Pool Simulator</h1>
            <p>Open 6 virtual booster packs from any Magic: The Gathering set, then build your 40-card sealed deck.</p>
        </div>

        <!-- Screen 1: Set Selection -->
        <div class="set-selection" id="setSelection">
            <h2>Choose a Set</h2>
            <div class="set-picker">
                <img class="set-icon" id="setIcon" src="" alt="" style="display:none;">
                <select id="setSelect" aria-label="Select an MTG set">
                    <option value="">Loading sets...</option>
                </select>
                <button class="btn-primary" id="openPacksBtn" disabled>Open 6 Packs</button>
            </div>
        </div>

        <!-- Screen 2: Pool View -->
        <div class="pool-section" id="poolSection">
            <div class="pool-controls">
                <h2>Your Pool <span style="color:var(--text-muted);font-weight:400;font-size:0.9rem;" id="poolCount">(84 cards)</span></h2>
                <div class="sort-buttons">
                    <button class="btn-secondary active" data-sort="color" onclick="sortPool('color')">Color</button>
                    <button class="btn-secondary" data-sort="type" onclick="sortPool('type')">Type</button>
                    <button class="btn-secondary" data-sort="cmc" onclick="sortPool('cmc')">CMC</button>
                    <button class="btn-secondary" data-sort="rarity" onclick="sortPool('rarity')">Rarity</button>
                </div>
            </div>
            <div class="action-bar">
                <button class="btn-secondary" onclick="resetDeck()">Clear Deck</button>
                <button class="btn-secondary" onclick="newPool()">New Pool</button>
            </div>
            <div class="pool-grid" id="poolGrid"></div>
        </div>

        <!-- Screen 3: Deck Builder -->
        <div class="builder-section" id="builderSection">
            <div class="builder-header">
                <h2>Your Deck</h2>
                <div class="deck-counter" id="deckCounter">
                    <span class="count" id="deckCount">0</span> / 40 cards
                </div>
            </div>

            <!-- Basic Lands Helper -->
            <div class="lands-helper">
                <h3>Add Basic Lands</h3>
                <div class="lands-row">
                    <div class="land-control">
                        <span class="land-label"><span class="land-dot" style="background:#F9FAF4;"></span> Plains</span>
                        <button class="land-btn" onclick="changeLand('Plains',-1)">-</button>
                        <span class="land-count" id="landPlains">0</span>
                        <button class="land-btn" onclick="changeLand('Plains',1)">+</button>
                    </div>
                    <div class="land-control">
                        <span class="land-label"><span class="land-dot" style="background:#0E68AB;"></span> Island</span>
                        <button class="land-btn" onclick="changeLand('Island',-1)">-</button>
                        <span class="land-count" id="landIsland">0</span>
                        <button class="land-btn" onclick="changeLand('Island',1)">+</button>
                    </div>
                    <div class="land-control">
                        <span class="land-label"><span class="land-dot" style="background:#150B00;border:1px solid rgba(255,255,255,0.3);"></span> Swamp</span>
                        <button class="land-btn" onclick="changeLand('Swamp',-1)">-</button>
                        <span class="land-count" id="landSwamp">0</span>
                        <button class="land-btn" onclick="changeLand('Swamp',1)">+</button>
                    </div>
                    <div class="land-control">
                        <span class="land-label"><span class="land-dot" style="background:#D3202A;"></span> Mountain</span>
                        <button class="land-btn" onclick="changeLand('Mountain',-1)">-</button>
                        <span class="land-count" id="landMountain">0</span>
                        <button class="land-btn" onclick="changeLand('Mountain',1)">+</button>
                    </div>
                    <div class="land-control">
                        <span class="land-label"><span class="land-dot" style="background:#00733E;"></span> Forest</span>
                        <button class="land-btn" onclick="changeLand('Forest',-1)">-</button>
                        <span class="land-count" id="landForest">0</span>
                        <button class="land-btn" onclick="changeLand('Forest',1)">+</button>
                    </div>
                </div>
            </div>

            <!-- CMC Curve -->
            <div class="curve-chart">
                <h3>Mana Curve</h3>
                <div class="curve-bars" id="curveBars">
                    <div class="curve-bar-wrapper"><span class="curve-count">0</span><div class="curve-bar" style="height:2px;"></div><span class="curve-label">0</span></div>
                    <div class="curve-bar-wrapper"><span class="curve-count">0</span><div class="curve-bar" style="height:2px;"></div><span class="curve-label">1</span></div>
                    <div class="curve-bar-wrapper"><span class="curve-count">0</span><div class="curve-bar" style="height:2px;"></div><span class="curve-label">2</span></div>
                    <div class="curve-bar-wrapper"><span class="curve-count">0</span><div class="curve-bar" style="height:2px;"></div><span class="curve-label">3</span></div>
                    <div class="curve-bar-wrapper"><span class="curve-count">0</span><div class="curve-bar" style="height:2px;"></div><span class="curve-label">4</span></div>
                    <div class="curve-bar-wrapper"><span class="curve-count">0</span><div class="curve-bar" style="height:2px;"></div><span class="curve-label">5</span></div>
                    <div class="curve-bar-wrapper"><span class="curve-count">0</span><div class="curve-bar" style="height:2px;"></div><span class="curve-label">6</span></div>
                    <div class="curve-bar-wrapper"><span class="curve-count">0</span><div class="curve-bar" style="height:2px;"></div><span class="curve-label">7+</span></div>
                </div>
            </div>

            <div class="deck-grid" id="deckGrid"></div>
        </div>
    </div>
</main>

<footer>
    <div class="container">
        <div class="footer-content">
            <div class="footer-logo">ScrollVault</div>
            <div class="wubrg-dots">
                <span class="mana-dot" style="background: #F9FAF4"></span>
                <span class="mana-dot" style="background: #0E68AB"></span>
                <span class="mana-dot" style="background: #150B00; border: 1px solid rgba(255,255,255,0.2)"></span>
                <span class="mana-dot" style="background: #D3202A"></span>
                <span class="mana-dot" style="background: #00733E"></span>
            </div>
            <p class="footer-text">&copy; 2026 scrollvault.net. Magic: The Gathering is a trademark of Wizards of the Coast. Card images &copy; Wizards of the Coast via Scryfall.</p>
            <ul class="footer-links">
                <li><a href="/privacy.html">Privacy Policy</a></li>
                <li><a href="/terms.html">Terms of Service</a></li>
                <li><a href="/contact.html">Contact</a></li>
                <li><a href="/about/authors.html">Authors</a></li>
                <li><a href="/about/editorial-policy.html">Editorial Policy</a></li>
            </ul>
        </div>
    </div>
</footer>

<script>
/* =========================================================
   Sealed Pool Simulator — ScrollVault
   ========================================================= */

// ── Scryfall rate-limit helper ──
const SCRYFALL_DELAY = 100;
let lastScryfallCall = 0;

async function scryfallFetch(url) {
    const now = Date.now();
    const wait = Math.max(0, SCRYFALL_DELAY - (now - lastScryfallCall));
    if (wait > 0) await new Promise(r => setTimeout(r, wait));
    lastScryfallCall = Date.now();
    const res = await fetch(url);
    if (!res.ok) throw new Error('Scryfall error: ' + res.status);
    return res.json();
}

// ── LocalStorage cache with 24h TTL ──
const CACHE_PREFIX = 'sv_sealed_';
const CACHE_TTL = 24 * 60 * 60 * 1000;
const MAX_CACHED_SETS = 3;

function cacheGet(key) {
    try {
        const item = JSON.parse(localStorage.getItem(CACHE_PREFIX + key));
        if (item && Date.now() - item.ts < CACHE_TTL) return item.data;
        localStorage.removeItem(CACHE_PREFIX + key);
    } catch {}
    return null;
}

function cacheSet(key, data) {
    try {
        // Enforce max cached sets
        const allKeys = [];
        for (let i = 0; i < localStorage.length; i++) {
            const k = localStorage.key(i);
            if (k && k.startsWith(CACHE_PREFIX)) {
                try {
                    const item = JSON.parse(localStorage.getItem(k));
                    allKeys.push({ key: k, ts: item.ts || 0 });
                } catch { allKeys.push({ key: k, ts: 0 }); }
            }
        }
        // Sort oldest first
        allKeys.sort((a, b) => a.ts - b.ts);
        while (allKeys.length >= MAX_CACHED_SETS) {
            const oldest = allKeys.shift();
            localStorage.removeItem(oldest.key);
        }
        localStorage.setItem(CACHE_PREFIX + key, JSON.stringify({ ts: Date.now(), data }));
    } catch {}
}

// ── Color helpers ──
const COLOR_ORDER = ['W', 'U', 'B', 'R', 'G'];
const COLOR_NAMES = { W: 'White', U: 'Blue', B: 'Black', R: 'Red', G: 'Green' };
const COLOR_HEX = { W: '#F9FAF4', U: '#0E68AB', B: '#150B00', R: '#D3202A', G: '#00733E' };
const RARITY_ORDER = { mythic: 0, rare: 1, uncommon: 2, common: 3 };

function getColorGroup(card) {
    const colors = card.colors || card.color_identity || [];
    if (isLand(card)) return 'Land';
    if (colors.length > 1) return 'Multi';
    if (colors.length === 1) return colors[0];
    return 'C'; // colorless
}

function colorSortKey(card) {
    const group = getColorGroup(card);
    const order = { W: 0, U: 1, B: 2, R: 3, G: 4, Multi: 5, C: 6, Land: 7 };
    return (order[group] !== undefined ? order[group] : 8) * 10000 + (card.cmc || 0) * 100 + card.name.charCodeAt(0);
}

function typeSortKey(card) {
    const tl = (card.type_line || '').toLowerCase();
    let rank = 9;
    if (tl.includes('creature')) rank = 0;
    else if (tl.includes('planeswalker')) rank = 1;
    else if (tl.includes('instant')) rank = 2;
    else if (tl.includes('sorcery')) rank = 3;
    else if (tl.includes('enchantment')) rank = 4;
    else if (tl.includes('artifact')) rank = 5;
    else if (tl.includes('land')) rank = 8;
    return rank * 10000 + (card.cmc || 0) * 100 + card.name.charCodeAt(0);
}

function cmcSortKey(card) {
    return (card.cmc || 0) * 10000 + colorSortKey(card);
}

function raritySortKey(card) {
    return (RARITY_ORDER[card.rarity] !== undefined ? RARITY_ORDER[card.rarity] : 4) * 100000 + colorSortKey(card);
}

function isLand(card) {
    return (card.type_line || '').toLowerCase().includes('land');
}

function getImageUri(card) {
    if (card.image_uris && card.image_uris.normal) return card.image_uris.normal;
    // Double-faced cards: use front face
    if (card.card_faces && card.card_faces[0] && card.card_faces[0].image_uris) {
        return card.card_faces[0].image_uris.normal;
    }
    return '';
}

function getCardColors(card) {
    if (card.colors && card.colors.length) return card.colors;
    if (card.card_faces) {
        const merged = new Set();
        card.card_faces.forEach(f => (f.colors || []).forEach(c => merged.add(c)));
        if (merged.size) return [...merged];
    }
    return card.color_identity || [];
}

// ── State ──
let allSets = [];
let setCards = {}; // { code: { commons, uncommons, rares, mythics } }
let pool = [];     // array of card objects in the pool
let deckSet = new Set(); // indices into pool that are in the deck
let basicLands = { Plains: 0, Island: 0, Swamp: 0, Mountain: 0, Forest: 0 };
let currentSort = 'color';

// ── DOM refs ──
const setSelect = document.getElementById('setSelect');
const setIcon = document.getElementById('setIcon');
const openPacksBtn = document.getElementById('openPacksBtn');
const loadingOverlay = document.getElementById('loadingOverlay');
const loadingText = document.getElementById('loadingText');
const loadingProgress = document.getElementById('loadingProgress');
const poolSection = document.getElementById('poolSection');
const poolGrid = document.getElementById('poolGrid');
const poolCount = document.getElementById('poolCount');
const builderSection = document.getElementById('builderSection');
const deckGrid = document.getElementById('deckGrid');
const deckCountEl = document.getElementById('deckCount');
const deckCounter = document.getElementById('deckCounter');
const setSelection = document.getElementById('setSelection');

// ── Init: Load sets ──
(async function init() {
    try {
        const cached = cacheGet('sets_list');
        let setsData;
        if (cached) {
            setsData = cached;
        } else {
            const json = await scryfallFetch('https://api.scryfall.com/sets');
            setsData = json.data;
            cacheSet('sets_list', setsData);
        }

        const validTypes = new Set(['core', 'expansion', 'draft_innovation', 'masters', 'funny']);
        allSets = setsData
            .filter(s => validTypes.has(s.set_type) && !s.digital && s.card_count > 0)
            .sort((a, b) => new Date(b.released_at) - new Date(a.released_at));

        setSelect.innerHTML = '<option value="">-- Select a set --</option>';
        allSets.forEach(s => {
            const opt = document.createElement('option');
            opt.value = s.code;
            opt.textContent = s.name + ' (' + s.code.toUpperCase() + ', ' + (s.released_at || '').slice(0, 4) + ')';
            opt.dataset.icon = s.icon_svg_uri || '';
            setSelect.appendChild(opt);
        });

        openPacksBtn.disabled = false;
    } catch (e) {
        setSelect.innerHTML = '<option value="">Failed to load sets. Refresh to retry.</option>';
        console.error('Failed to load sets:', e);
    }
})();

setSelect.addEventListener('change', function () {
    const opt = setSelect.options[setSelect.selectedIndex];
    const iconUrl = opt ? opt.dataset.icon : '';
    if (iconUrl) {
        setIcon.src = iconUrl;
        setIcon.style.display = 'block';
    } else {
        setIcon.style.display = 'none';
    }
});

openPacksBtn.addEventListener('click', () => openPacks());

async function openPacks() {
    const code = setSelect.value;
    if (!code) return;

    openPacksBtn.disabled = true;
    showLoading('Fetching cards from Scryfall...');

    try {
        const cards = await fetchSetCards(code);
        if (!cards) throw new Error('No cards found');

        // Categorize by rarity
        const commons = cards.filter(c => c.rarity === 'common');
        const uncommons = cards.filter(c => c.rarity === 'uncommon');
        const rares = cards.filter(c => c.rarity === 'rare');
        const mythics = cards.filter(c => c.rarity === 'mythic');

        if (commons.length < 10 || uncommons.length < 3 || rares.length < 1) {
            throw new Error('Not enough cards of each rarity to build boosters.');
        }

        // Generate 6 boosters
        pool = [];
        for (let i = 0; i < 6; i++) {
            const booster = generateBooster(commons, uncommons, rares, mythics);
            pool.push(...booster);
        }

        // Normalize card colors
        pool.forEach(c => {
            c.colors = getCardColors(c);
        });

        // Reset deck
        deckSet.clear();
        basicLands = { Plains: 0, Island: 0, Swamp: 0, Mountain: 0, Forest: 0 };
        updateLandDisplay();

        // Show pool
        hideLoading();
        poolSection.classList.add('visible');
        builderSection.classList.add('visible');
        currentSort = 'color';
        document.querySelectorAll('.sort-buttons .btn-secondary').forEach(b => {
            b.classList.toggle('active', b.dataset.sort === 'color');
        });
        renderPool();
        renderDeck();
        updateDeckCounter();
        updateCurve();
        poolSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
    } catch (e) {
        hideLoading();
        openPacksBtn.disabled = false;
        alert('Error: ' + e.message);
        console.error(e);
    }
}

async function fetchSetCards(code) {
    const cached = cacheGet('cards_' + code);
    if (cached) return cached;

    let allCards = [];
    let url = 'https://api.scryfall.com/cards/search?q=set:' + encodeURIComponent(code) + '+is:booster&order=set';
    let page = 1;

    while (url) {
        updateLoading('Fetching cards from Scryfall...', 'Page ' + page + '...');
        const json = await scryfallFetch(url);
        allCards = allCards.concat(json.data);
        if (json.has_more && json.next_page) {
            url = json.next_page;
            page++;
        } else {
            url = null;
        }
    }

    // Store minimal card data to save cache space
    const minCards = allCards.map(c => ({
        name: c.name,
        rarity: c.rarity,
        cmc: c.cmc || 0,
        colors: getCardColors(c),
        color_identity: c.color_identity || [],
        type_line: c.type_line || '',
        image_uris: c.image_uris ? { normal: c.image_uris.normal } : null,
        card_faces: c.card_faces ? c.card_faces.map(f => ({
            colors: f.colors || [],
            image_uris: f.image_uris ? { normal: f.image_uris.normal } : null
        })) : null,
        mana_cost: c.mana_cost || ''
    }));

    cacheSet('cards_' + code, minCards);
    return minCards;
}

function generateBooster(commons, uncommons, rares, mythics) {
    const booster = [];

    // 1 Rare/Mythic (1 in 8 chance for mythic)
    if (mythics.length > 0 && Math.random() < 1 / 8) {
        booster.push({ ...randomPick(mythics) });
    } else {
        booster.push({ ...randomPick(rares) });
    }

    // 3 Uncommons (try to avoid duplicates within booster)
    const usedUC = new Set();
    for (let i = 0; i < 3; i++) {
        let attempts = 0;
        let card;
        do {
            card = randomPick(uncommons);
            attempts++;
        } while (usedUC.has(card.name) && attempts < 20);
        usedUC.add(card.name);
        booster.push({ ...card });
    }

    // 10 Commons (try to avoid duplicates within booster)
    const usedC = new Set();
    for (let i = 0; i < 10; i++) {
        let attempts = 0;
        let card;
        do {
            card = randomPick(commons);
            attempts++;
        } while (usedC.has(card.name) && attempts < 30);
        usedC.add(card.name);
        booster.push({ ...card });
    }

    return booster;
}

function randomPick(arr) {
    return arr[Math.floor(Math.random() * arr.length)];
}

// ── Sorting ──
function sortPool(sortBy) {
    currentSort = sortBy;
    document.querySelectorAll('.sort-buttons .btn-secondary').forEach(b => {
        b.classList.toggle('active', b.dataset.sort === sortBy);
    });
    renderPool();
}

function getSortedIndices() {
    const indices = pool.map((_, i) => i);
    const sortFn = {
        color: (a, b) => colorSortKey(pool[a]) - colorSortKey(pool[b]),
        type: (a, b) => typeSortKey(pool[a]) - typeSortKey(pool[b]),
        cmc: (a, b) => cmcSortKey(pool[a]) - cmcSortKey(pool[b]),
        rarity: (a, b) => raritySortKey(pool[a]) - raritySortKey(pool[b])
    };
    indices.sort(sortFn[currentSort] || sortFn.color);
    return indices;
}

// ── Rendering ──
function renderPool() {
    const sorted = getSortedIndices();
    poolGrid.innerHTML = '';
    poolCount.textContent = '(' + pool.length + ' cards)';

    sorted.forEach(idx => {
        const card = pool[idx];
        const slot = createCardSlot(card, idx);
        if (deckSet.has(idx)) {
            slot.classList.add('in-deck');
        }
        poolGrid.appendChild(slot);
    });
}

function createCardSlot(card, idx) {
    const slot = document.createElement('div');
    slot.className = 'card-slot';
    slot.dataset.idx = idx;

    const imgUrl = getImageUri(card);
    if (imgUrl) {
        const img = document.createElement('img');
        img.src = imgUrl;
        img.alt = card.name;
        img.loading = 'lazy';
        img.onerror = function () {
            this.style.display = 'none';
            const ph = document.createElement('div');
            ph.className = 'card-placeholder';
            ph.textContent = card.name;
            slot.appendChild(ph);
        };
        slot.appendChild(img);
    } else {
        const ph = document.createElement('div');
        ph.className = 'card-placeholder';
        ph.textContent = card.name;
        slot.appendChild(ph);
    }

    slot.addEventListener('click', () => toggleCard(idx));
    slot.title = card.name + ' (' + card.rarity + ')';
    return slot;
}

function toggleCard(idx) {
    if (deckSet.has(idx)) {
        deckSet.delete(idx);
    } else {
        deckSet.add(idx);
    }
    renderPool();
    renderDeck();
    updateDeckCounter();
    updateCurve();
}

function renderDeck() {
    deckGrid.innerHTML = '';

    // Sort deck cards by CMC then color
    const deckIndices = [...deckSet].sort((a, b) => {
        const ca = pool[a], cb = pool[b];
        const cmcDiff = (ca.cmc || 0) - (cb.cmc || 0);
        if (cmcDiff !== 0) return cmcDiff;
        return colorSortKey(ca) - colorSortKey(cb);
    });

    deckIndices.forEach(idx => {
        const card = pool[idx];
        const slot = createCardSlot(card, idx);
        slot.classList.add('in-deck');
        deckGrid.appendChild(slot);
    });
}

function updateDeckCounter() {
    const totalLands = Object.values(basicLands).reduce((s, v) => s + v, 0);
    const total = deckSet.size + totalLands;
    deckCountEl.textContent = total;
    deckCounter.classList.toggle('complete', total === 40);
}

// ── Basic Lands ──
function changeLand(type, delta) {
    basicLands[type] = Math.max(0, (basicLands[type] || 0) + delta);
    updateLandDisplay();
    updateDeckCounter();
    updateCurve();
}

function updateLandDisplay() {
    Object.keys(basicLands).forEach(type => {
        const el = document.getElementById('land' + type);
        if (el) el.textContent = basicLands[type];
    });
}

// ── Mana Curve ──
function updateCurve() {
    const buckets = new Array(8).fill(0); // 0,1,2,3,4,5,6,7+

    deckSet.forEach(idx => {
        const card = pool[idx];
        if (isLand(card)) return; // don't count lands in curve
        const cmc = Math.min(Math.floor(card.cmc || 0), 7);
        buckets[cmc]++;
    });

    const max = Math.max(...buckets, 1);
    const wrappers = document.getElementById('curveBars').children;

    for (let i = 0; i < 8; i++) {
        const wrapper = wrappers[i];
        if (!wrapper) continue;
        const bar = wrapper.querySelector('.curve-bar');
        const countEl = wrapper.querySelector('.curve-count');
        const pct = (buckets[i] / max) * 100;
        bar.style.height = Math.max(2, pct * 0.7) + 'px';
        countEl.textContent = buckets[i] || '';
    }
}

// ── Reset / New Pool ──
function resetDeck() {
    deckSet.clear();
    basicLands = { Plains: 0, Island: 0, Swamp: 0, Mountain: 0, Forest: 0 };
    updateLandDisplay();
    renderPool();
    renderDeck();
    updateDeckCounter();
    updateCurve();
}

function newPool() {
    poolSection.classList.remove('visible');
    builderSection.classList.remove('visible');
    poolGrid.innerHTML = '';
    deckGrid.innerHTML = '';
    pool = [];
    deckSet.clear();
    basicLands = { Plains: 0, Island: 0, Swamp: 0, Mountain: 0, Forest: 0 };
    updateLandDisplay();
    openPacksBtn.disabled = false;
    setSelection.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

// ── Loading helpers ──
function showLoading(text) {
    loadingText.textContent = text || 'Loading...';
    loadingProgress.textContent = '';
    loadingOverlay.classList.add('visible');
}

function updateLoading(text, progress) {
    if (text) loadingText.textContent = text;
    if (progress) loadingProgress.textContent = progress;
}

function hideLoading() {
    loadingOverlay.classList.remove('visible');
}
</script>
</body>
</html>
